<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { padding: 15px; background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .panel-row { background: white; margin-bottom: 20px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #ccc; transition: all 0.3s; }
        .panel-row.completed { border-left-color: #198754; } 
        .sub-item-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 8px 0; }
        .sub-item-row:last-child { border-bottom: none; }
        .sub-item-label { font-size: 0.95rem; color: #333; }
        .preview-img { max-width: 100%; height: 200px; object-fit: contain; margin-top: 10px; border: 1px solid #ddd; display: none; background-color: #f8f9fa;}
        .required-star { color: red; }
        .badge-type { font-size: 0.8em; background-color: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .fab-btn { box-shadow: 0 4px 6px rgba(0,0,0,0.2); border-radius: 50px; padding: 10px 20px; font-weight: bold; font-size: 0.9em; }
        .backup-controls { margin-bottom: 15px; background: #e2e3e5; padding: 10px; border-radius: 8px; text-align: center; }

        /* PDF Styles */
        #printArea { position: absolute; top: -9999px; left: -9999px; width: 210mm; padding: 10mm; background: white; color: black; box-sizing: border-box; }
        .print-item-block { border: 1px solid #000; margin-bottom: -1px; page-break-inside: avoid; }
        .print-header { background-color: #eee; padding: 5px 10px; border-bottom: 1px solid #000; font-weight: bold; display: flex; justify-content: space-between; }
        .print-sub-items { display: grid; grid-template-columns: 1fr 1fr; }
        .print-sub-item { border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 5px; font-size: 10pt; }
        .print-sub-item:nth-child(even) { border-right: none; }
        .print-note { padding: 5px; border-bottom: 1px solid #000; font-size: 10pt; background-color: #fff; }
        .print-img-box { text-align: center; padding: 5px; }
        .print-img { max-height: 180px; max-width: 95%; object-fit: contain; }
        
        .version-tag { font-size: 0.75rem; color: #6c757d; display: block; text-align: center; margin-top: -5px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="fab-container">
    <button type="button" class="btn btn-warning fab-btn text-dark" onclick="manualSave()">ğŸ’¾ æš«å­˜é€²åº¦</button>
    <button type="button" class="btn btn-danger fab-btn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤é‡å¡«</button>
</div>

<div class="container mb-5">
    <div class="sticky-top bg-white p-3 shadow-sm mb-3 rounded" style="z-index: 1000;">
        <h4 class="text-center fw-bold m-0" id="pageTitle">èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</h4>
        <span class="version-tag">Ver: v1.0</span>
        
        <div class="progress mt-2" style="height: 5px;">
            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <small class="text-muted" id="progressText">è«‹å…ˆé¸æ“‡ç³»çµ±èˆ‡å€åŸŸ...</small>
            <small class="text-success fw-bold" id="autoSaveStatus" style="display:none;">âœ… å·²è‡ªå‹•å„²å­˜</small>
        </div>
    </div>
    
    <div class="backup-controls">
        <span class="fw-bold me-2">ğŸ“‚ é€²åº¦å‚™ä»½ï¼š</span>
        <button type="button" class="btn btn-sm btn-outline-dark me-2" onclick="exportBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½æª”</button>
        <label class="btn btn-sm btn-outline-dark">
            â¬†ï¸ è®€å–å‚™ä»½æª”
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(this)">
        </label>
    </div>

    <form id="checkForm">
        <div class="card p-3 mb-3">
            <h5 class="card-title">åŸºæœ¬è³‡æ–™</h5>
            
            <div class="mb-3">
                <label class="form-label fw-bold text-primary">1. é¸æ“‡æª¢æŸ¥é¡åˆ¥ (System)</label>
                <select class="form-select form-select-lg" id="systemSelect" onchange="changeSystem()">
                    <option value="" disabled selected>-- è«‹å…ˆé¸æ“‡ç³»çµ± --</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold text-primary">2. é¸æ“‡å€åŸŸ/æ¨“å±¤ (Area)</label>
                <select class="form-select form-select-lg" id="areaSelect" onchange="changeArea()" disabled>
                    <option value="" disabled selected>-- è«‹å…ˆé¸æ“‡ç³»çµ± --</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">æª¢æŸ¥æ™‚é–“ (è‡ªå‹•å¸¶å…¥)</label>
                <input type="text" class="form-control" id="checkDate" readonly style="background-color: #e9ecef; font-weight: bold;">
            </div>
            
            <div class="mb-3">
                <label class="form-label">æª¢æŸ¥äººå“¡ <span class="required-star">*</span></label>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check"><input class="form-check-input inspector-check" type="checkbox" value="Albert" onchange="checkProgress(); autoSave()"><label class="form-check-label">Albert</label></div><div class="form-check"><input class="form-check-input inspector-check" type="checkbox" value="Alden" onchange="checkProgress(); autoSave()"><label class="form-check-label">Alden</label></div><div class="form-check"><input class="form-check-input inspector-check" type="checkbox" value="Ocean" onchange="checkProgress(); autoSave()"><label class="form-check-label">Ocean</label></div><div class="form-check"><input class="form-check-input inspector-check" type="checkbox" value="Stenfer" onchange="checkProgress(); autoSave()"><label class="form-check-label">Stenfer</label></div>
                    <div class="form-check">
                        <input class="form-check-input inspector-check" type="checkbox" value="Other" id="inspOther" onchange="toggleOtherInput(); checkProgress(); autoSave()">
                        <label class="form-check-label" for="inspOther">Other</label>
                    </div>
                </div>
                <input type="text" class="form-control mt-2" id="otherNameInput" placeholder="è«‹è¼¸å…¥å§“å" style="display: none;" oninput="checkProgress(); autoSave()">
            </div>
        </div>
        <div id="panelList"></div>
        <div class="d-grid gap-2 mt-4 pb-5">
            <button type="button" id="btn-generate" class="btn btn-secondary btn-lg" onclick="generatePDF()" disabled>ğŸ”’ è«‹å…ˆå®Œæˆæª¢æŸ¥</button>
            <button type="button" class="btn btn-outline-success btn-lg" onclick="sendEmail()">ğŸ“§ æ­¥é©Ÿ2ï¼šå¯„ä¿¡çµ¦ Ocean</button>
        </div>
    </form>
</div>

<div id="printArea">
    <div id="printTitleBlock" style="margin-bottom: 10px;">
        <h2 style="text-align: center; margin-bottom: 5px;">èšé™½å¯¦æ¥­ - <span id="printSystem"></span> <span id="printAreaName"></span> æª¢æŸ¥è¡¨</h2>
        <div style="text-align: right; font-size: 11pt; border-bottom: 2px solid #000; padding-bottom: 5px;">
            <strong>æª¢æŸ¥æ™‚é–“ï¼š</strong><span id="printDate"></span> &nbsp;|&nbsp; <strong>æª¢æŸ¥äººå“¡ï¼š</strong><span id="printInspector"></span>
        </div>
        <div style="text-align: right; font-size: 9pt; color: #666;">è¡¨å–®ç‰ˆæœ¬: v1.0</div>
    </div>
    <div id="printItemsContainer"></div>
</div>

<script>
    // PWA Service Worker è¨»å†Š
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(reg => {
            console.log('Service Worker è¨»å†ŠæˆåŠŸ', reg);
            // æª¢æŸ¥æ›´æ–°
            reg.onupdatefound = () => {
                const installingWorker = reg.installing;
                installingWorker.onstatechange = () => {
                    if (installingWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                            // æ–°ç‰ˆæœ¬å·²å®‰è£ï¼Œæç¤ºä½¿ç”¨è€…é‡æ–°æ•´ç†
                            if(confirm("æª¢æ¸¬åˆ°æ–°ç‰ˆæœ¬ï¼è«‹æŒ‰ä¸‹ç¢ºå®šä»¥é‡æ–°è¼‰å…¥æ›´æ–°ã€‚")) {
                                window.location.reload();
                            }
                        }
                    }
                };
            };
        })
        .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—', err));
    }

    const allData = {"(æ¯æœˆ)æ¶ˆé˜²è¨­å‚™å®šæœŸæ’¿æŸ¥": {"2F": [{"name": "2Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "2Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "2Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "2Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "2Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "2Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "2Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "2Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "3F": [{"name": "3Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "3Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "3Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "3Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "3Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "3Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "3Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "3Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "4F": [{"name": "4Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "4Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "4Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "4Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "4Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "4Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "4Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "4Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "5F": [{"name": "5Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "5Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "5Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "5Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "5Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "5Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "5Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "5Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "6F": [{"name": "6Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "6Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "6Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "6Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "6Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "6Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "6Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "6Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "7F": [{"name": "7Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "7Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "7Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "7Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "7Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "7Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "7Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "7Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}], "8F": [{"name": "8Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "8Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "8Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "8Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "8Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "8Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "8Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "8Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}]}, "(æ¯æœˆ)ä¸€èˆ¬ä½œæ¥­ç’°å¢ƒå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "3F": [{"name": "3Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "4F": [{"name": "4Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "5F": [{"name": "5Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "6F": [{"name": "6Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "7F": [{"name": "7Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "8F": [{"name": "8Fä¸€èˆ¬ä½œæ¥­ç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}]}, "(æ¯æœˆ)ç™¼é›»æ©Ÿè¨­å‚™å®šæœŸæª¢æŸ¥": {"ç¸½éƒ¨æ©Ÿæˆ¿": [{"name": "4Fç™¼é›»æ©Ÿ", "template": "ç™¼é›»æ©Ÿ"}]}, "(æ¯å­£)ç©ºèª¿è¨­å‚™å®šæœŸæª¢æŸ¥": {"ç©ºèª¿è¨­å‚™": [{"name": "2Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "3Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "4Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "5Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "6Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "7Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "8Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}]}, "(æ¯å­£)é£²æ°´æ©Ÿå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fé£²æ°´æ©Ÿ", "template": "2Fé£²æ°´æ©Ÿ"}], "3F": [{"name": "3Fé£²æ°´æ©Ÿ", "template": "3Fé£²æ°´æ©Ÿ"}], "4F": [{"name": "4Fé£²æ°´æ©Ÿ", "template": "4Fé£²æ°´æ©Ÿ"}], "5F": [{"name": "5Fé£²æ°´æ©Ÿ", "template": "5Fé£²æ°´æ©Ÿ"}], "6F": [{"name": "6Fé£²æ°´æ©Ÿ", "template": "6Fé£²æ°´æ©Ÿ"}], "7F": [{"name": "7Fé£²æ°´æ©Ÿ", "template": "7Fé£²æ°´æ©Ÿ"}], "8F": [{"name": "8Fé£²æ°´æ©Ÿ", "template": "8Fé£²æ°´æ©Ÿ"}]}, "(æ¯å¹´)ä½å£“é›»æ°£è¨­å‚™å®šæœŸæ’¿æŸ¥": {"2F": [{"name": "2-HR", "template": "é›»ç®±"}, {"name": "2-L", "template": "é›»ç®±"}, {"name": "2-R", "template": "é›»ç®±"}, {"name": "2-MP", "template": "é›»ç®±"}, {"name": "MP1 (2F)", "template": "é›»ç®±"}, {"name": "MA1 (2F)", "template": "é›»ç®±"}, {"name": "L2 (2F)", "template": "é›»ç®±"}, {"name": "å‰µç ”è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "2Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "2MLR", "template": "é›»ç®±"}, {"name": "MA-2é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "MA-3é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "2MLR-Aç›¤", "template": "é›»ç®±"}, {"name": "å·¥å‹™è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}], "3F": [{"name": "3F A-1", "template": "é›»ç®±"}, {"name": "3F A-2", "template": "é›»ç®±"}, {"name": "3F B", "template": "é›»ç®±"}], "4F": [{"name": "4-Ræ’åº§", "template": "é›»ç®±"}, {"name": "4-HRæ’åº§", "template": "é›»ç®±"}, {"name": "4-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "4-MLRç›¤", "template": "é›»ç®±"}, {"name": "4Fç©ºèª¿ç›¤", "template": "é›»ç®±"}], "5F": [{"name": "5-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "5Fç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "5MLRç›¤", "template": "é›»ç®±"}], "6F": [{"name": "6-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "6æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "6-MLRç›¤", "template": "é›»ç®±"}], "7F": [{"name": "7Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "7æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "7MLRç›¤", "template": "é›»ç®±"}], "8F": [{"name": "8-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "8æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "8-MLRç›¤", "template": "é›»ç®±"}]}};
    const templates = {"é›»ç®±": ["1. å¤–æ®¼èˆ‡é–€è“‹é–æ‰£ (å¤–è§€å®Œæ•´)", "2. å‘¨åœç’°å¢ƒ (ç„¡é›œç‰©/ç©æ°´)", "3. ç·šè·¯æ¥é»æº«åº¦ (ç„¡ç•°å¸¸ç™¼ç†±)", "4. ä¿è­·è£ç½®åŠŸèƒ½ (æ¨™ç¤ºæ¸…æ™°)"], "æ»…ç«å™¨": ["1. å£“åŠ›è¡¨(ç¶ è‰²ç¯„åœ)", "2. å®‰å…¨æ’éŠ·(æ­£å¸¸ä¸”æœªæ‹†å°)", "3. çš®ç®¡å™´å˜´(ç„¡è®Šå½¢ç•°å¸¸)", "4. ç“¶èº«å¤–è§€(ç„¡é½è•è®Šå½¢)", "5. æ¨™ç¤ºæœŸé™(æ¸…æ™°ã€æª¢æŸ¥å¡ã€è—¥åŠ‘)", "6. æ“ºæ”¾ä½ç½®(æ˜“å–å¾—ã€å­—æ¨£æ¸…æ™°)"], "æ¶ˆé˜²æ “ç®±": ["1. ç®±é«”å‘¨åœ(é›œç‰©å †ç©)", "2. æŒ‡ç¤ºç‡ˆ(æ˜¯å¦ç´…ç‡ˆæ†äº®)", "3. ç®±é–€é–‹é—œ(æ˜¯å¦èƒ½æ­£å¸¸é–‹å•Ÿ)", "4. ç„å­(å™´å˜´æ˜¯å¦æ­£å¸¸)", "5. æ°´å¸¶(æ‘ºç–Šæ›å¥½)", "6. é–‹é—œé–¥(æ­£å¸¸å®Œå¥½)"], "ç«ç½æ¢æ¸¬å™¨": ["1. æ˜¯å¦è¢«è£æ½¢ã€å†·æ°£å‡ºé¢¨å£é®è”½", "2. æ˜¯å¦è¢«é«˜ç–Šçš„è²¨ç‰©ï¼ˆæ¨£å“ï¼‰é˜»æ“‹æ„Ÿæ‡‰", "3. å¤–è§€æ˜¯å¦é¬†è„«ã€æ‡¸åŠ"], "ç«ç½è­¦éˆ´/å»£æ’­": ["1. å¤–è§€æ˜¯å¦å®Œå¥½", "2. æœ‰ç„¡è¢«å°æ­»æˆ–ç ´å£"], "å‡ºå£æ¨™ç¤ºç‡ˆ": ["1. æ˜¯å¦24å°æ™‚æ†äº®", "2. ç‡ˆç½©æ˜¯å¦ç ´æã€æ¨¡ç³Š", "3. æ˜¯å¦è¢«è£æ½¢é®è”½"], "ç·Šæ€¥ç…§æ˜ç‡ˆ": ["1. æ’é ­æ˜¯å¦æ’åœ¨æ’åº§ä¸Š", "2. æ¸¬è©¦éˆ•æŒ‰ä¸‹æ˜¯å¦æœƒäº®", "3. å¤–è§€æ˜¯å¦ç„¦é»‘æˆ–é›»æ± æ¼æ¶²"], "é˜²ç«é–€": ["1. æ˜¯å¦å¸¸æ™‚é—œé–‰", "2. æ˜¯å¦å †æ”¾é›œç‰©é˜»ç¤™é–‹å•Ÿ", "3. é–€å¼“å™¨æ˜¯å¦èƒ½è‡ªå‹•å°‡é–€å¸¶ä¸Š"], "ç™¼é›»æ©Ÿ": ["1. ç‡ƒæ–™å­˜é‡èˆ‡ç®¡ç·š (ç„¡æ´©æ¼)", "2. æ©Ÿæ²¹/å†·å»æ°´ (æ¶²ä½æ­£å¸¸)", "3. æ’ç…™èˆ‡é€šé¢¨ (é †æš¢ç„¡æ)", "4. å™ªéŸ³èˆ‡éœ‡å‹• (ç„¡ç•°å¸¸)", "5. é›»ç“¶é›»å£“ (æ¥é ­ç„¡è…è•)", "6. ATSè‡ªå‹•åˆ‡æ› (æ¸¬è©¦æ­£å¸¸)", "7. è¼¸å‡ºé›»å£“é »ç‡ (æ¨™æº–ç¯„åœ)", "8. æ¥åœ°ç·šé€£æ¥ (ç„¡é¬†è„«)"], "2Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "3Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "4Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "5Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "6Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "7Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "8Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "ä¸­å¤®ç©ºèª¿": ["1. ä¸»æ©Ÿé‹è½‰ç‹€æ…‹ (ç„¡ç•°éŸ³)", "2. æ•£ç†±æ’/éæ¿¾ç¶² (æ¸…æ½”)", "3. è¨­å‚™å‘¨åœç’°å¢ƒ (é€šé¢¨)", "4. æ’æ°´ç›¤/å†·å‡æ°´ç®¡ (ç„¡å µå¡)", "5. å†°æ°´ç®¡ç·šä¿æº« (ç„¡æ»´æ°´)", "6. é›»æ°£æ¥é» (ç„¡éç†±)", "7. å®‰å…¨é˜²è­·è£ç½® (åŠŸèƒ½æ­£å¸¸)"], "ä½œæ¥­ç’°å¢ƒ": ["1. èµ°é“èˆ‡ç·Šæ€¥å‡ºå£ (ç„¡å †ç©)", "2. ç…§æ˜èˆ‡çœ©å…‰ (ç…§åº¦è¶³å¤ )", "3. è¾¦å…¬æ¡Œæ¤… (ç„¡ç ´æ)", "4. é›»è…¦è¨­å‚™é…ç½® (äººé«”å·¥å­¸)", "5. å»¶é•·ç·šèˆ‡é›»ç·š (ç„¡å£“é‡ç‰©)", "6. é£²æ°´æ©Ÿ/åŠ ç†±è¨­å‚™ (ç„¡æ¼æ°´/æ¼é›»)", "7. å»¢æ£„ç‰©è™•ç† (åˆ†é¡æ­£ç¢º)"]};
    let currentSystem = "", currentArea = "", currentItems = [];
    
    // DB
    const DB_NAME = "ChecklistDB_V8";
    const DB_VERSION = 1;
    let db;
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = function(event) { db = event.target.result; if (!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = function(event) { db = event.target.result; initPage(); };
    request.onerror = function(event) { console.error("DB Error", event); initPage(); };

    function initPage() {
        setInitTime();
        const savedSys = localStorage.getItem('last_system');
        const savedArea = localStorage.getItem('last_area');
        const sysSelect = document.getElementById('systemSelect');
        Object.keys(allData).forEach(sys => { const option = document.createElement("option"); option.value = sys; option.text = sys; sysSelect.appendChild(option); });
        if(savedSys && allData[savedSys]) {
            sysSelect.value = savedSys; changeSystem();
            if(savedArea && allData[savedSys][savedArea]) { document.getElementById('areaSelect').value = savedArea; changeArea(); }
        }
    }

    function setInitTime() {
        const now = new Date();
        const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById('checkDate').value = timeStr;
    }

    function toggleOtherInput() {
        document.getElementById('otherNameInput').style.display = document.getElementById('inspOther').checked ? 'block' : 'none';
    }

    function changeSystem() {
        currentSystem = document.getElementById('systemSelect').value;
        const areaSelect = document.getElementById('areaSelect');
        areaSelect.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡å€åŸŸ --</option>';
        areaSelect.disabled = false;
        Object.keys(allData[currentSystem]).forEach(area => { const option = document.createElement("option"); option.value = area; option.text = area; areaSelect.appendChild(option); });
        document.getElementById('panelList').innerHTML = ""; currentItems = []; checkProgress();
        localStorage.setItem('last_system', currentSystem);
    }

    function changeArea() {
        currentArea = document.getElementById('areaSelect').value;
        currentItems = allData[currentSystem][currentArea];
        document.getElementById('pageTitle').innerText = `${currentSystem} - ${currentArea}`;
        localStorage.setItem('last_area', currentArea);
        renderPanels(); loadDraftFromDB(); checkProgress();
    }

    function renderPanels() {
        const container = document.getElementById('panelList'); container.innerHTML = "";
        if (!currentItems) return;
        currentItems.forEach((itemObj, pIndex) => {
            const subItems = templates[itemObj.template] || [];
            let subItemsHtml = '';
            subItems.forEach((checkItem, sIndex) => {
                subItemsHtml += `<div class="sub-item-row"><span class="sub-item-label">${checkItem}</span><div class="btn-group btn-group-sm" role="group"><input type="radio" class="btn-check" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_pass" value="åˆæ ¼" onchange="checkProgress(); autoSave()"><label class="btn btn-outline-success" for="p${pIndex}_s${sIndex}_pass">åˆæ ¼</label><input type="radio" class="btn-check" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_fail" value="ä¸åˆæ ¼" onchange="checkProgress(); autoSave()"><label class="btn btn-outline-danger" for="p${pIndex}_s${sIndex}_fail">ç•°å¸¸</label></div></div>`;
            });
            container.innerHTML += `<div class="panel-row" id="row_${pIndex}"><div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom"><h5 class="fw-bold text-primary m-0">${pIndex + 1}. ${itemObj.name}<span class="badge-type">${itemObj.template}</span></h5><button type="button" class="btn btn-sm btn-outline-primary" onclick="setAllPass(${pIndex}, ${subItems.length})">âš¡ ä¸€éµå…¨åˆæ ¼</button></div><div class="mb-3">${subItemsHtml}</div><input type="text" class="form-control mb-2" id="note_${pIndex}" placeholder="å‚™è¨»..." oninput="autoSave()"><label class="btn btn-secondary btn-sm w-100 mb-2">ğŸ“· æ‹æ”ç…§ç‰‡<input type="file" id="img_${pIndex}" accept="image/*" capture="environment" style="display: none;" onchange="previewImg(this, ${pIndex})"></label><div class="text-center"><img id="preview_${pIndex}" class="preview-img"></div></div>`;
        });
    }

    function setAllPass(pIndex, count) { for(let s=0; s<count; s++) { const el = document.getElementById(`p${pIndex}_s${s}_pass`); if(el) el.checked = true; } checkProgress(); autoSave(); }
    
    function previewImg(input, index) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(`preview_${index}`); img.src = e.target.result; img.style.display = 'inline-block';
                document.getElementById(`row_${index}`).classList.add("completed"); checkProgress(); autoSave();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function checkProgress() {
        if (!currentItems || currentItems.length === 0) return;
        let totalSubItems = 0, checkedSubItems = 0, photoCount = 0;
        currentItems.forEach((itemObj, p) => {
            const subCount = (templates[itemObj.template] || []).length; totalSubItems += subCount;
            for (let s = 0; s < subCount; s++) { if (document.querySelector(`input[name="p${p}_s${s}"]:checked`)) checkedSubItems++; }
            const imgPreview = document.getElementById(`preview_${p}`);
            if (imgPreview.src && imgPreview.style.display !== 'none') photoCount++;
        });
        let hasInspector = false;
        document.querySelectorAll('.inspector-check:checked').forEach(cb => { if (cb.value === 'Other') { if (document.getElementById('otherNameInput').value.trim() !== '') hasInspector = true; } else { hasInspector = true; } });
        
        const progress = totalSubItems === 0 ? 0 : Math.round(((checkedSubItems / totalSubItems) * 0.5 + (photoCount / currentItems.length) * 0.5) * 100);
        document.getElementById('progressBar').style.width = `${progress}%`;
        const btn = document.getElementById('btn-generate');
        if (checkedSubItems === totalSubItems && photoCount === currentItems.length && hasInspector) { btn.disabled = false; btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); btn.innerHTML = `ğŸ“¥ ä¸‹è¼‰ ${currentSystem}_${currentArea} PDF`; } 
        else { btn.disabled = true; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); btn.innerHTML = "ğŸ”’ å°šæœªå®Œæˆ"; }
    }

    function getStorageKey() { if(!currentSystem || !currentArea) return null; return `${document.title}_${currentSystem}_${currentArea}`; }
    let saveTimeout; function autoSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { manualSave(true); }, 500); }
    
    function manualSave(silent = false) {
        if (!db) return; const key = getStorageKey(); if (!key) return;
        const radios = [], notes = {}, inspectors = [], images = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => radios.push(r.id));
        document.querySelectorAll('input[type="text"][id^="note_"]').forEach(n => { if(n.value) notes[n.id] = n.value; });
        document.querySelectorAll('.inspector-check:checked').forEach(i => inspectors.push(i.value));
        document.querySelectorAll('.preview-img').forEach(img => { if (img.src && img.src.startsWith('data:image')) images[img.id] = img.src; });
        const data = { id: key, radios, notes, inspectors, otherName: document.getElementById('otherNameInput').value, images, timestamp: new Date().getTime() };
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
        if(!silent) { const status = document.getElementById('autoSaveStatus'); status.style.display = 'block'; setTimeout(() => status.style.display = 'none', 2000); }
    }

    function loadDraftFromDB() {
        if (!db) return; const key = getStorageKey(); if (!key) return;
        const tx = db.transaction(["drafts"]); const req = tx.objectStore("drafts").get(key);
        req.onsuccess = function(e) {
            const data = e.target.result;
            if (data) {
                if(data.radios) data.radios.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
                if(data.notes) Object.keys(data.notes).forEach(id => { const el = document.getElementById(id); if(el) el.value = data.notes[id]; });
                document.querySelectorAll('.inspector-check').forEach(c => c.checked = false);
                if(data.inspectors) data.inspectors.forEach(val => { const el = document.querySelector(`.inspector-check[value="${val}"]`); if(el) el.checked = true; if(val === 'Other') { document.getElementById('inspOther').checked = true; toggleOtherInput(); } });
                if(data.otherName) document.getElementById('otherNameInput').value = data.otherName;
                if(data.images) Object.keys(data.images).forEach(id => { const img = document.getElementById(id); if(img) { img.src = data.images[id]; img.style.display = 'inline-block'; const rowId = id.replace('preview_', 'row_'); const row = document.getElementById(rowId); if(row) row.classList.add('completed'); } });
                checkProgress();
            }
        };
    }

    function clearDraft() {
        if(!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ­¤å€åŸŸçš„æ‰€æœ‰æš«å­˜è³‡æ–™å—ï¼Ÿ")) return;
        if (!db) return;
        const key = getStorageKey();
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").delete(key);
        document.getElementById('checkForm').reset(); setInitTime(); toggleOtherInput();
        document.querySelectorAll('.preview-img').forEach(img => { img.src = ""; img.style.display = "none"; });
        document.querySelectorAll('.panel-row').forEach(row => row.classList.remove('completed'));
        checkProgress();
    }

    function exportBackup() {
        if (!db) return; const key = getStorageKey(); if (!key) { alert("è«‹å…ˆé¸æ“‡å€åŸŸ"); return; }
        const req = db.transaction(["drafts"]).objectStore("drafts").get(key);
        req.onsuccess = function(e) {
            const data = e.target.result; if(!data) { alert("ç„¡è³‡æ–™å¯å‚™ä»½"); return; }
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
            a.download = `backup_${currentSystem}_${currentArea}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
    }

    function importBackup(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result); data.id = getStorageKey();
                const tx = db.transaction(["drafts"], "readwrite"); 
                tx.objectStore("drafts").put(data);
                tx.oncomplete = function() { alert("âœ… å‚™ä»½è®€å–æˆåŠŸï¼"); loadDraftFromDB(); };
            } catch(err) { alert("è®€å–å¤±æ•—"); }
        };
        reader.readAsText(file); input.value = '';
    }

    async function generatePDF() {
        const btn = document.getElementById('btn-generate'); btn.innerHTML = "â³ ç”Ÿæˆä¸­..."; btn.disabled = true;
        let inspectors = []; document.querySelectorAll('.inspector-check:checked').forEach(cb => { if (cb.value === 'Other') inspectors.push(document.getElementById('otherNameInput').value); else inspectors.push(cb.value); });
        document.getElementById('printSystem').innerText = currentSystem; document.getElementById('printAreaName').innerText = currentArea;
        document.getElementById('printDate').innerText = document.getElementById('checkDate').value; document.getElementById('printInspector').innerText = inspectors.join(", ");
        const container = document.getElementById('printItemsContainer'); container.innerHTML = "";
        currentItems.forEach((itemObj, pIndex) => {
            const subItems = templates[itemObj.template] || []; let subItemsHtml = "";
            subItems.forEach((item, sIndex) => {
                const isPass = document.getElementById(`p${pIndex}_s${sIndex}_pass`).checked; const resultText = isPass ? "âœ… åˆæ ¼" : "âŒ ç•°å¸¸"; const resultStyle = isPass ? "" : "color:red; font-weight:bold;";
                subItemsHtml += `<div class="print-sub-item">${item.split('(')[0]} <span style="float:right; ${resultStyle}">${resultText}</span></div>`;
            });
            const note = document.getElementById(`note_${pIndex}`).value; const imgElement = document.getElementById(`preview_${pIndex}`);
            container.innerHTML += `<div class="print-item-block" id="print-item-${pIndex}"><div class="print-header"><span>${pIndex + 1}. ${itemObj.name} (${itemObj.template})</span><span>çµæœè©³æƒ…</span></div><div class="print-sub-items">${subItemsHtml}</div><div class="print-note"><strong>å‚™è¨»ï¼š</strong>${note || "ç„¡"}</div><div class="print-img-box"><img src="${imgElement.src}" class="print-img"></div></div>`;
        });
        const printArea = document.getElementById('printArea'); printArea.style.top = "0"; printArea.style.zIndex = "-1";
        try {
            const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210; const contentWidth = 190; let cursorY = 10;
            const titleBlock = document.getElementById('printTitleBlock');
            const canvasTitle = await html2canvas(titleBlock, { scale: 2 });
            pdf.addImage(canvasTitle.toDataURL('image/png'), 'PNG', 10, cursorY, contentWidth, (canvasTitle.height * contentWidth) / canvasTitle.width);
            cursorY += (canvasTitle.height * contentWidth) / canvasTitle.width + 5;
            for (let i = 0; i < currentItems.length; i++) {
                const itemBlock = document.getElementById(`print-item-${i}`);
                const canvasItem = await html2canvas(itemBlock, { scale: 2 });
                const imgHeight = (canvasItem.height * contentWidth) / canvasItem.width;
                if (cursorY + imgHeight > 280) { pdf.addPage(); cursorY = 10; }
                pdf.addImage(canvasItem.toDataURL('image/jpeg', 0.8), 'JPEG', 10, cursorY, contentWidth, imgHeight);
                cursorY += imgHeight + 2;
            }
            const fileDate = document.getElementById('checkDate').value.replace(/[: ]/g, '_');
            pdf.save(`${currentSystem}_${currentArea}_${fileDate}.pdf`);
            btn.innerHTML = `ğŸ“¥ ä¸‹è¼‰ PDF`; btn.disabled = false;
        } catch (err) { alert("éŒ¯èª¤: " + err); btn.disabled = false; } finally { printArea.style.top = "-9999px"; }
    }
    function sendEmail() { window.location.href = `mailto:oceanchen@makalot.com.tw?subject=${encodeURIComponent(`[æª¢æŸ¥è¡¨] ${currentSystem}-${currentArea}`)}&body=${encodeURIComponent("è«‹è©³é–±é™„æª”ã€‚")}`; }
</script>
</body>
</html>