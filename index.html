<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* === å…¨å±€åŸºç¤æ¨£å¼ === */
        body { padding: 10px; padding-bottom: 120px; background-color: #f0f2f5; font-family: -apple-system, "Microsoft JhengHei", sans-serif; color: #333; }
        
        /* === 1. æ“ä½œä»‹é¢ (App Mode) === */
        .container { max-width: 800px; margin: 0 auto; }
        
        /* å¡ç‰‡èˆ‡å€å¡Š */
        .card-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .section-title { 
            font-size: 1.1rem; font-weight: bold; color: #0288d1; 
            border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; 
        }

        /* è¼¸å…¥æ¬„ä½ */
        label { font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
        select, input[type="text"], .btn-select { 
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; 
            font-size: 16px; margin-bottom: 15px; background: #fff; display: block;
        }
        .btn-select { text-align: left; background-color: #fff; color: #333; }

        /* æª¢æŸ¥é …ç›®å¡ç‰‡ */
        .panel-row { 
            background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; 
        }
        .panel-row.completed { border-left-color: #198754; } 
        .panel-row.error { border-left-color: #dc3545; border: 2px solid #dc3545; background-color: #fff8f8; }

        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .item-title { font-weight: bold; font-size: 1.1rem; color: #333; }
        .badge-temp { font-size: 0.75rem; background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; }

        /* ç´°é …æª¢æŸ¥åˆ— */
        .sub-item-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .sub-item-row:last-child { border-bottom: none; }
        .sub-item-label { font-size: 0.95rem; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-check-group { display: flex; gap: 5px; }
        .btn-check-group input { display: none; }
        .btn-check-label { 
            padding: 8px 15px; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; 
            font-size: 0.95rem; color: #666; background: #fff; transition: 0.2s;
        }
        .btn-check-pass:checked + label { background: #198754; color: white; border-color: #198754; }
        .btn-check-fail:checked + label { background: #dc3545; color: white; border-color: #dc3545; }

        /* ç…§ç‰‡é è¦½ */
        .preview-container { text-align: center; margin-top: 10px; }
        .preview-img { max-width: 100%; height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; display: none; }

        /* â˜…â˜…â˜… ç°½åæ¿ (ä¿®æ­£CSS) â˜…â˜…â˜… */
        .sig-wrapper { 
            position: relative; width: 100%; height: 180px; 
            border: 2px dashed #ccc; border-radius: 8px; background: #fff;
            touch-action: none; /* é—œéµï¼šé˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•æ™‚æ²å‹•é é¢ */
        }
        canvas { width: 100%; height: 100%; cursor: crosshair; display: block; }
        .sig-error { border-color: #dc3545; background: #fff5f5; }

        /* FAB æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .btn-float { 
            display: flex; align-items: center; justify-content: center; padding: 12px 20px; 
            border-radius: 50px; color: white; font-weight: bold; border: none; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; min-width: 140px; transition: 0.2s;
        }
        .btn-float:active { transform: scale(0.95); }
        .btn-main { background: linear-gradient(135deg, #0288d1, #03a9f4); }
        .btn-sub { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-warn { background: linear-gradient(135deg, #c0392b, #e74c3c); font-size: 0.9rem; }

        /* === 2. å ±å‘Šæ¨£å¼ (ä¸‹è¼‰å¾Œç”Ÿæ•ˆ) === */
        .report-body { background: white !important; padding: 40px !important; max-width: 900px !important; margin: 0 auto !important; }
        
        .report-header { text-align: center; border-bottom: 3px solid #0288d1; margin-bottom: 25px; padding-bottom: 15px; }
        .report-title { font-size: 1.8rem; font-weight: 900; color: #000; margin: 0; }
        .report-info-bar { background: #f8f9fa; border-left: 5px solid #0288d1; padding: 10px 15px; margin-bottom: 30px; font-weight: bold; color: #333; font-size: 1.05rem; }

        /* å ±å‘Šå…§å®¹å€å¡Š (ç¶­æŒèˆŠç‰ˆçš„å¤§åœ–é¢¨æ ¼) */
        .report-item { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
        .report-item-head { background: #f1f3f5; padding: 8px 12px; font-weight: bold; font-size: 1.1rem; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .report-sub-items { margin-bottom: 10px; padding-left: 10px; }
        .report-sub-item { margin-bottom: 4px; font-size: 0.95rem; }
        .report-note { color: #666; font-style: italic; margin-bottom: 10px; padding: 5px; background: #fffbe6; border-radius: 4px; display: inline-block; }
        
        /* å ±å‘Šåœ–ç‰‡ (å¤§å°ºå¯¸) */
        .report-img-large { max-height: 350px; max-width: 100%; border: 1px solid #ccc; padding: 2px; border-radius: 4px; display: block; margin: 5px 0; }

        .txt-pass { color: #198754; font-weight: bold; }
        .txt-fail { color: #dc3545; font-weight: bold; }

        /* å ±å‘Šç°½åå€ (æ–°å¼é›™æ¬„) */
        .report-footer { margin-top: 50px; display: flex; gap: 50px; page-break-inside: avoid; }
        .sig-box { flex: 1; }
        .sig-line { border-top: 1px solid #000; padding-top: 5px; font-weight: bold; text-align: center; }
        .sig-img-final { height: 60px; display: block; margin: 0 auto; }
        .sig-placeholder { height: 60px; display: flex; align-items: flex-end; justify-content: center; color: #ccc; }
    </style>
</head>
<body>

<div class="fab-container">
    <button type="button" class="btn-float btn-sub" onclick="sendEmail()">ğŸ“§ å¯„çµ¦è² è²¬äºº</button>
    <button type="button" class="btn-float btn-main" onclick="downloadReport()">ğŸ“¥ ä¸‹è¼‰å ±å‘Š</button>
    <button type="button" class="btn-float btn-warn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤é‡å¡«</button>
</div>

<div class="container">
    
    <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color:#0288d1; font-weight:bold; margin-bottom:5px;">èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</h3>
        <div style="color:#888; font-size:0.8rem;">Ver: 19</div>
        <div id="pageTitle" style="font-weight:bold; margin-top:5px; font-size:1.1rem; color:#555;">è«‹é¸æ“‡ç³»çµ±...</div>
        <small id="autoSaveStatus" style="color:green; display:none;">âœ… å·²è‡ªå‹•å„²å­˜</small>
    </div>

    <div style="background:#e9ecef; padding:8px; border-radius:6px; margin-bottom:15px; display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn btn-sm btn-outline-secondary" onclick="exportBackup()">ğŸ“‚ ä¸‹è¼‰å‚™ä»½</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('importFile').click()">ğŸ“‚ è®€å–å‚™ä»½</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(this)">
    </div>

    <form id="checkForm">
        <div class="card-box">
            <div class="section-title">1. åŸºæœ¬è³‡æ–™</div>
            
            <label>ç³»çµ± System</label>
            <select id="systemSelect" onchange="changeSystem()">
                <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
            </select>

            <label>å€åŸŸ Area</label>
            <select id="areaSelect" onchange="changeArea()" disabled>
                <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
            </select>

            <div class="row">
                <div class="col-6">
                    <label>æ—¥æœŸ Date</label>
                    <input type="text" id="checkDate" readonly>
                </div>
                <div class="col-6">
                    <label>äººå“¡ Inspector</label>
                    <button type="button" class="btn-select" id="inspectorBtn" onclick="toggleInspectorModal()">è«‹é¸æ“‡...</button>
                </div>
            </div>

            <div id="inspectorModal" style="display:none; background:#f8f9fa; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:5px;">
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    <label style="font-weight:normal; background:white; padding:5px 10px; border:1px solid #ccc; border-radius:4px;"><input type="checkbox" class="inspector-check" value="Albert" onchange="autoSave(); updateInspectorBtn()"> Albert</label><label style="font-weight:normal; background:white; padding:5px 10px; border:1px solid #ccc; border-radius:4px;"><input type="checkbox" class="inspector-check" value="Alden" onchange="autoSave(); updateInspectorBtn()"> Alden</label><label style="font-weight:normal; background:white; padding:5px 10px; border:1px solid #ccc; border-radius:4px;"><input type="checkbox" class="inspector-check" value="Ocean" onchange="autoSave(); updateInspectorBtn()"> Ocean</label><label style="font-weight:normal; background:white; padding:5px 10px; border:1px solid #ccc; border-radius:4px;"><input type="checkbox" class="inspector-check" value="Stenfer" onchange="autoSave(); updateInspectorBtn()"> Stenfer</label>
                    <label style="font-weight:normal; background:white; padding:5px 10px; border:1px solid #ccc; border-radius:4px;">
                        <input type="checkbox" class="inspector-check" value="Other" id="inspOther" onchange="toggleOtherInput(); autoSave();"> Other
                    </label>
                </div>
                <input type="text" id="otherNameInput" placeholder="è¼¸å…¥å§“å..." style="display:none; margin-top:10px;" oninput="autoSave(); updateInspectorBtn()">
            </div>
        </div>

        <div id="panelList"></div>

        <div class="card-box" id="sig-section" style="display:none;">
            <div class="section-title">3. ç°½åç¢ºèª <span style="color:red; font-size:0.8rem;">(å¿…å¡«)</span></div>
            <div class="sig-wrapper" id="sig-container">
                <canvas id="sig-canvas"></canvas>
            </div>
            <button type="button" style="margin-top:10px; background:#eee; border:none; padding:8px 15px; border-radius:15px; cursor:pointer;" onclick="clearSignature()">â†º æ¸…é™¤é‡ç°½</button>
        </div>
    </form>
</div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.onupdatefound = () => {
                const newWorker = reg.installing;
                newWorker.onstatechange = () => { if (newWorker.state === 'installed' && navigator.serviceWorker.controller && confirm("æœ‰æ–°ç‰ˆæœ¬ï¼Œè«‹æ›´æ–°")) window.location.reload(); };
            };
        });
    }

    const allData = {"(æ¯æœˆ)æ¶ˆé˜²è¨­å‚™èˆ‡ä¸€èˆ¬ç’°å¢ƒå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "2Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "2Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "2Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "2Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "2Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "2Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "2Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "2Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "3F": [{"name": "3Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "3Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "3Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "3Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "3Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "3Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "3Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "3Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "3Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "4F": [{"name": "4Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "4Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "4Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "4Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "4Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "4Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "4Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "4Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "4Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "5F": [{"name": "5Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "5Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "5Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "5Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "5Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "5Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "5Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "5Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "5Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "6F": [{"name": "6Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "6Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "6Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "6Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "6Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "6Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "6Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "6Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "6Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "7F": [{"name": "7Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "7Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "7Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "7Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "7Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "7Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "7Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "7Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "7Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "8F": [{"name": "8Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "8Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "8Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "8Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "8Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "8Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "8Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "8Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "8Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}]}, "(æ¯æœˆ)ç™¼é›»æ©Ÿè¨­å‚™å®šæœŸæª¢æŸ¥": {"ç¸½éƒ¨æ©Ÿæˆ¿": [{"name": "4Fç™¼é›»æ©Ÿ", "template": "ç™¼é›»æ©Ÿ"}]}, "(æ¯å­£)ç©ºèª¿è¨­å‚™å®šæœŸæª¢æŸ¥": {"ç©ºèª¿è¨­å‚™": [{"name": "2Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "3Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "4Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "5Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "6Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "7Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "8Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}]}, "(æ¯å­£)é£²æ°´æ©Ÿå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fé£²æ°´æ©Ÿ", "template": "2Fé£²æ°´æ©Ÿ"}], "3F": [{"name": "3Fé£²æ°´æ©Ÿ", "template": "3Fé£²æ°´æ©Ÿ"}], "4F": [{"name": "4Fé£²æ°´æ©Ÿ", "template": "4Fé£²æ°´æ©Ÿ"}], "5F": [{"name": "5Fé£²æ°´æ©Ÿ", "template": "5Fé£²æ°´æ©Ÿ"}], "6F": [{"name": "6Fé£²æ°´æ©Ÿ", "template": "6Fé£²æ°´æ©Ÿ"}], "7F": [{"name": "7Fé£²æ°´æ©Ÿ", "template": "7Fé£²æ°´æ©Ÿ"}], "8F": [{"name": "8Fé£²æ°´æ©Ÿ", "template": "8Fé£²æ°´æ©Ÿ"}]}, "(æ¯å¹´)ä½å£“é›»æ°£è¨­å‚™å®šæœŸæ’¿æŸ¥": {"2F": [{"name": "2-HR", "template": "é›»ç®±"}, {"name": "2-L", "template": "é›»ç®±"}, {"name": "2-R", "template": "é›»ç®±"}, {"name": "2-MP", "template": "é›»ç®±"}, {"name": "MP1 (2F)", "template": "é›»ç®±"}, {"name": "MA1 (2F)", "template": "é›»ç®±"}, {"name": "L2 (2F)", "template": "é›»ç®±"}, {"name": "å‰µç ”è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "2Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "2MLR", "template": "é›»ç®±"}, {"name": "MA-2é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "MA-3é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "2MLR-Aç›¤", "template": "é›»ç®±"}, {"name": "å·¥å‹™è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}], "3F": [{"name": "3F A-1", "template": "é›»ç®±"}, {"name": "3F A-2", "template": "é›»ç®±"}, {"name": "3F B", "template": "é›»ç®±"}], "4F": [{"name": "4-Ræ’åº§", "template": "é›»ç®±"}, {"name": "4-HRæ’åº§", "template": "é›»ç®±"}, {"name": "4-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "4-MLRç›¤", "template": "é›»ç®±"}, {"name": "4Fç©ºèª¿ç›¤", "template": "é›»ç®±"}], "5F": [{"name": "5-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "5Fç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "5MLRç›¤", "template": "é›»ç®±"}], "6F": [{"name": "6-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "6æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "6-MLRç›¤", "template": "é›»ç®±"}], "7F": [{"name": "7Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "7æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "7MLRç›¤", "template": "é›»ç®±"}], "8F": [{"name": "8-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "8æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "8-MLRç›¤", "template": "é›»ç®±"}]}};
    const templates = {"é›»ç®±": ["1. å¤–æ®¼èˆ‡é–€è“‹é–æ‰£ (å¤–è§€å®Œæ•´)", "2. å‘¨åœç’°å¢ƒ (ç„¡é›œç‰©/ç©æ°´)", "3. ç·šè·¯æ¥é»æº«åº¦ (ç„¡ç•°å¸¸ç™¼ç†±)", "4. ä¿è­·è£ç½®åŠŸèƒ½ (æ¨™ç¤ºæ¸…æ™°)"], "æ»…ç«å™¨": ["1. å£“åŠ›è¡¨(ç¶ è‰²ç¯„åœ)", "2. å®‰å…¨æ’éŠ·(æ­£å¸¸ä¸”æœªæ‹†å°)", "3. çš®ç®¡å™´å˜´(ç„¡è®Šå½¢ç•°å¸¸)", "4. ç“¶èº«å¤–è§€(ç„¡é½è•è®Šå½¢)", "5. æ¨™ç¤ºæœŸé™(æ¸…æ™°ã€æª¢æŸ¥å¡ã€è—¥åŠ‘)", "6. æ“ºæ”¾ä½ç½®(æ˜“å–å¾—ã€å­—æ¨£æ¸…æ™°)"], "æ¶ˆé˜²æ “ç®±": ["1. ç®±é«”å‘¨åœ(é›œç‰©å †ç©)", "2. æŒ‡ç¤ºç‡ˆ(æ˜¯å¦ç´…ç‡ˆæ†äº®)", "3. ç®±é–€é–‹é—œ(æ˜¯å¦èƒ½æ­£å¸¸é–‹å•Ÿ)", "4. ç„å­(å™´å˜´æ˜¯å¦æ­£å¸¸)", "5. æ°´å¸¶(æ‘ºç–Šæ›å¥½)", "6. é–‹é—œé–¥(æ­£å¸¸å®Œå¥½)"], "ç«ç½æ¢æ¸¬å™¨": ["1. æ˜¯å¦è¢«è£æ½¢ã€å†·æ°£å‡ºé¢¨å£é®è”½", "2. æ˜¯å¦è¢«é«˜ç–Šçš„è²¨ç‰©ï¼ˆæ¨£å“ï¼‰é˜»æ“‹æ„Ÿæ‡‰", "3. å¤–è§€æ˜¯å¦é¬†è„«ã€æ‡¸åŠ"], "ç«ç½è­¦éˆ´/å»£æ’­": ["1. å¤–è§€æ˜¯å¦å®Œå¥½", "2. æœ‰ç„¡è¢«å°æ­»æˆ–ç ´å£"], "å‡ºå£æ¨™ç¤ºç‡ˆ": ["1. æ˜¯å¦24å°æ™‚æ†äº®", "2. ç‡ˆç½©æ˜¯å¦ç ´æã€æ¨¡ç³Š", "3. æ˜¯å¦è¢«è£æ½¢é®è”½"], "ç·Šæ€¥ç…§æ˜ç‡ˆ": ["1. æ’é ­æ˜¯å¦æ’åœ¨æ’åº§ä¸Š", "2. æ¸¬è©¦éˆ•æŒ‰ä¸‹æ˜¯å¦æœƒäº®", "3. å¤–è§€æ˜¯å¦ç„¦é»‘æˆ–é›»æ± æ¼æ¶²"], "é˜²ç«é–€": ["1. æ˜¯å¦å¸¸æ™‚é—œé–‰", "2. æ˜¯å¦å †æ”¾é›œç‰©é˜»ç¤™é–‹å•Ÿ", "3. é–€å¼“å™¨æ˜¯å¦èƒ½è‡ªå‹•å°‡é–€å¸¶ä¸Š"], "ç™¼é›»æ©Ÿ": ["1. ç‡ƒæ–™å­˜é‡èˆ‡ç®¡ç·š (ç„¡æ´©æ¼)", "2. æ©Ÿæ²¹/å†·å»æ°´ (æ¶²ä½æ­£å¸¸)", "3. æ’ç…™èˆ‡é€šé¢¨ (é †æš¢ç„¡æ)", "4. å™ªéŸ³èˆ‡éœ‡å‹• (ç„¡ç•°å¸¸)", "5. é›»ç“¶é›»å£“ (æ¥é ­ç„¡è…è•)", "6. ATSè‡ªå‹•åˆ‡æ› (æ¸¬è©¦æ­£å¸¸)", "7. è¼¸å‡ºé›»å£“é »ç‡ (æ¨™æº–ç¯„åœ)", "8. æ¥åœ°ç·šé€£æ¥ (ç„¡é¬†è„«)"], "2Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "3Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "4Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "5Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "6Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "7Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "8Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "ä¸­å¤®ç©ºèª¿": ["1. ä¸»æ©Ÿé‹è½‰ç‹€æ…‹ (ç„¡ç•°éŸ³)", "2. æ•£ç†±æ’/éæ¿¾ç¶² (æ¸…æ½”)", "3. è¨­å‚™å‘¨åœç’°å¢ƒ (é€šé¢¨)", "4. æ’æ°´ç›¤/å†·å‡æ°´ç®¡ (ç„¡å µå¡)", "5. å†°æ°´ç®¡ç·šä¿æº« (ç„¡æ»´æ°´)", "6. é›»æ°£æ¥é» (ç„¡éç†±)", "7. å®‰å…¨é˜²è­·è£ç½® (åŠŸèƒ½æ­£å¸¸)"], "ä½œæ¥­ç’°å¢ƒ": ["1. èµ°é“èˆ‡ç·Šæ€¥å‡ºå£ (ç„¡å †ç©)", "2. ç…§æ˜æ­£å¸¸èˆ‡ç‡ˆå…·ç„¡æå£", "3. å»¶é•·ç·šèˆ‡é›»ç·š (ç„¡å£“é‡ç‰©)", "4. é£²æ°´æ©Ÿ/åŠ ç†±è¨­å‚™ (ç„¡æ¼æ°´/æ¼é›»)", "5. å»¢æ£„ç‰©è™•ç† (åˆ†é¡æ­£ç¢º)"]};
    let currentSystem = "", currentArea = "", currentItems = [];
    
    // IndexedDB Setup
    const DB_NAME = "ChecklistDB_V19"; const DB_VERSION = 1; let db;
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = (e) => { db = e.target.result; initPage(); };

    // ===============================================
    // â˜…â˜…â˜… ç°½åæ¿æ ¸å¿ƒä¿®å¾© (High DPI + Touch) â˜…â˜…â˜…
    // ===============================================
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // é‡æ–°è¨ˆç®— Canvas å°ºå¯¸ (åŒ…å« Retina è¢å¹•æ”¯æ´)
    function resizeCanvas() {
        const wrapper = canvas.parentElement;
        const rect = wrapper.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        ctx.scale(ratio, ratio);
        
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#000';
    }
    // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ DOM æ¸²æŸ“å®Œç•¢
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 500);

    // å–å¾—æ­£ç¢ºåº§æ¨™
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { 
            x: clientX - rect.left, 
            y: clientY - rect.top 
        };
    }

    function startDraw(e) { 
        // é˜»æ­¢é»˜èªæ»¾å‹•è¡Œç‚º
        if(e.target === canvas) e.preventDefault();
        isDrawing = true; 
        const pos = getPos(e);
        ctx.beginPath(); 
        ctx.moveTo(pos.x, pos.y); 
    }

    function draw(e) { 
        if (!isDrawing) return; 
        if(e.target === canvas) e.preventDefault();
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y); 
        ctx.stroke(); 
    }

    function stopDraw() { 
        if(isDrawing) { 
            isDrawing = false; 
            autoSave(); 
        } 
    }
    
    // ç¶å®šå®Œæ•´äº‹ä»¶ (æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§)
    canvas.addEventListener('mousedown', startDraw); 
    canvas.addEventListener('mousemove', draw); 
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    
    canvas.addEventListener('touchstart', startDraw, {passive:false}); 
    canvas.addEventListener('touchmove', draw, {passive:false}); 
    canvas.addEventListener('touchend', stopDraw);
    
    function clearSignature() { 
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        autoSave(); 
    }
    
    function isCanvasBlank() { 
        const blank = document.createElement('canvas'); 
        blank.width = canvas.width; 
        blank.height = canvas.height; 
        return canvas.toDataURL() === blank.toDataURL(); 
    }

    // ===============================================
    // æ‡‰ç”¨ç¨‹å¼é‚è¼¯
    // ===============================================
    function initPage() {
        const now = new Date();
        document.getElementById('checkDate').value = now.toISOString().split('T')[0];
        
        const sysSelect = document.getElementById('systemSelect');
        Object.keys(allData).forEach(sys => { sysSelect.add(new Option(sys, sys)); });
        
        const savedSys = localStorage.getItem('last_system');
        if(savedSys && allData[savedSys]) {
            sysSelect.value = savedSys; changeSystem();
            const savedArea = localStorage.getItem('last_area');
            if(savedArea && allData[savedSys][savedArea]) { document.getElementById('areaSelect').value = savedArea; changeArea(); }
        }
    }

    function toggleInspectorModal() { const m = document.getElementById('inspectorModal'); m.style.display = m.style.display === 'none' ? 'block' : 'none'; }
    function toggleOtherInput() { document.getElementById('otherNameInput').style.display = document.getElementById('inspOther').checked ? 'block' : 'none'; }
    function updateInspectorBtn() {
        const checked = Array.from(document.querySelectorAll('.inspector-check:checked')).map(c => c.value === 'Other' ? document.getElementById('otherNameInput').value : c.value);
        document.getElementById('inspectorBtn').innerText = checked.length ? checked.join(", ") : "è«‹é¸æ“‡...";
        autoSave();
    }

    function changeSystem() {
        currentSystem = document.getElementById('systemSelect').value;
        const areaSelect = document.getElementById('areaSelect');
        areaSelect.innerHTML = '<option disabled selected>-- è«‹é¸æ“‡ --</option>'; areaSelect.disabled = false;
        Object.keys(allData[currentSystem]).forEach(area => areaSelect.add(new Option(area, area)));
        document.getElementById('panelList').innerHTML = ""; currentItems = []; document.getElementById('sig-section').style.display = 'none';
        localStorage.setItem('last_system', currentSystem);
    }

    function changeArea() {
        currentArea = document.getElementById('areaSelect').value;
        currentItems = allData[currentSystem][currentArea];
        document.getElementById('pageTitle').innerText = `${currentSystem} - ${currentArea}`;
        localStorage.setItem('last_area', currentArea);
        renderPanels(); 
        document.getElementById('sig-section').style.display = 'block';
        setTimeout(resizeCanvas, 100); // ç¢ºä¿é¡¯ç¤ºå¾Œé‡ç¹ª
        loadDraftFromDB();
    }

    function renderPanels() {
        const container = document.getElementById('panelList'); container.innerHTML = "";
        currentItems.forEach((item, pIndex) => {
            const subItems = templates[item.template] || [];
            let subsHtml = "";
            subItems.forEach((sub, sIndex) => {
                subsHtml += `
                <div class="sub-item-row">
                    <div class="sub-item-label">${sub}</div>
                    <div class="btn-check-group">
                        <input type="radio" class="btn-check-pass" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_pass" value="Pass" onchange="autoSave()">
                        <label class="btn-check-label" for="p${pIndex}_s${sIndex}_pass">åˆæ ¼</label>
                        <input type="radio" class="btn-check-fail" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_fail" value="Fail" onchange="autoSave()">
                        <label class="btn-check-label" for="p${pIndex}_s${sIndex}_fail">ç•°å¸¸</label>
                    </div>
                </div>`;
            });

            const html = `
            <div class="panel-row" id="row_${pIndex}">
                <div class="item-header">
                    <div>
                        <div class="item-title">${pIndex+1}. ${item.name}</div>
                        <span class="badge-temp">${item.template}</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="quickPass(${pIndex}, ${subItems.length})">âš¡ ä¸€éµåˆæ ¼</button>
                </div>
                ${subsHtml}
                <input type="text" id="note_${pIndex}" placeholder="å‚™è¨»èªªæ˜..." oninput="autoSave()">
                <label class="btn btn-secondary w-100 mb-2">
                    ğŸ“· æ‹æ”ç…§ç‰‡ (å¿…å¡«)
                    <input type="file" id="file_${pIndex}" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this, ${pIndex})">
                </label>
                <div class="preview-container"><img id="preview_${pIndex}" class="preview-img"></div>
            </div>`;
            container.innerHTML += html;
        });
    }

    function quickPass(pIndex, count) {
        for(let i=0; i<count; i++) { document.getElementById(`p${pIndex}_s${i}_pass`).checked = true; }
        autoSave();
    }

    function handleImage(input, idx) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(`preview_${idx}`);
                img.src = e.target.result; img.style.display = 'inline-block';
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // è‡ªå‹•å­˜æª” & è®€å–
    function getStorageKey() { return (currentSystem && currentArea) ? `${document.title}_${currentSystem}_${currentArea}` : null; }
    let saveTimer; function autoSave() { clearTimeout(saveTimer); saveTimer = setTimeout(saveToDB, 500); }
    
    function saveToDB() {
        if(!db || !getStorageKey()) return;
        const data = {
            id: getStorageKey(),
            system: currentSystem, area: currentArea,
            radios: Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(r => r.id),
            notes: Array.from(document.querySelectorAll('input[type="text"][id^="note_"]')).reduce((acc, el) => ({...acc, [el.id]: el.value}), {}),
            images: Array.from(document.querySelectorAll('.preview-img')).reduce((acc, img) => (img.src && img.src.startsWith('data:') ? {...acc, [img.id]: img.src} : acc), {}),
            inspectorText: document.getElementById('inspectorBtn').innerText,
            signature: isCanvasBlank() ? null : canvas.toDataURL()
        };
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
        tx.oncomplete = () => { document.getElementById('autoSaveStatus').style.display='inline'; setTimeout(()=>document.getElementById('autoSaveStatus').style.display='none', 2000); };
    }

    function loadDraftFromDB() {
        if(!db || !getStorageKey()) return;
        db.transaction(["drafts"]).objectStore("drafts").get(getStorageKey()).onsuccess = (e) => {
            const data = e.target.result;
            if(!data) return;
            if(data.radios) data.radios.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
            if(data.notes) Object.keys(data.notes).forEach(k => { const el = document.getElementById(k); if(el) el.value = data.notes[k]; });
            if(data.images) Object.keys(data.images).forEach(k => { 
                const img = document.getElementById(k); 
                if(img) { img.src = data.images[k]; img.style.display = 'inline-block'; } 
            });
            if(data.inspectorText) document.getElementById('inspectorBtn').innerText = data.inspectorText;
            if(data.signature) { 
                const i = new Image(); i.src = data.signature; 
                i.onload = () => ctx.drawImage(i,0,0, canvas.width, canvas.height); 
            }
        };
    }
    
    function exportBackup() {
        if (!db) return; const key = getStorageKey(); if (!key) { alert("è«‹å…ˆé¸æ“‡å€åŸŸ"); return; }
        db.transaction(["drafts"]).objectStore("drafts").get(key).onsuccess = function(e) {
            const data = e.target.result; if(!data) { alert("ç„¡è³‡æ–™å¯å‚™ä»½"); return; }
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
            a.download = `backup_${currentSystem}_${currentArea}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
    }

    function importBackup(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result); data.id = getStorageKey();
                const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
                tx.oncomplete = function() { alert("âœ… å‚™ä»½è®€å–æˆåŠŸï¼"); loadDraftFromDB(); };
            } catch(err) { alert("è®€å–å¤±æ•—"); }
        };
        reader.readAsText(file); input.value = '';
    }

    function clearDraft() {
        if(confirm("ç¢ºå®šæ¸…é™¤æ­¤å€åŸŸè³‡æ–™ï¼Ÿ")) {
            db.transaction(["drafts"], "readwrite").objectStore("drafts").delete(getStorageKey());
            location.reload();
        }
    }

    // ===============================================
    // ä¸‹è¼‰å ±å‘Š (å¼·åˆ¶æª¢æŸ¥ç…§ç‰‡)
    // ===============================================
    function downloadReport() {
        if(!currentSystem || !currentArea) { alert("è«‹é¸æ“‡å€åŸŸ"); return; }
        const inspectorNames = document.getElementById('inspectorBtn').innerText;
        if(inspectorNames.includes("è«‹é¸æ“‡")) { alert("è«‹é¸æ“‡æª¢æŸ¥äººå“¡"); return; }
        
        // 1. å¼·åˆ¶æª¢æŸ¥ (ç´°é …èˆ‡ç…§ç‰‡)
        if(isCanvasBlank()) {
            alert("âŒ è«‹ç°½åï¼");
            document.getElementById('sig-canvas').classList.add('sig-error');
            document.getElementById('sig-section').scrollIntoView();
            return;
        }
        
        let errorCount = 0;
        let firstError = null;

        currentItems.forEach((item, idx) => {
            const subItems = templates[item.template] || [];
            let isCheckOK = true;
            subItems.forEach((_, sIdx) => {
                if(!document.getElementById(`p${idx}_s${sIdx}_pass`).checked && 
                   !document.getElementById(`p${idx}_s${sIdx}_fail`).checked) isCheckOK = false;
            });
            
            const img = document.getElementById(`preview_${idx}`);
            const hasPhoto = (img && img.src && img.style.display !== 'none');

            const row = document.getElementById(`row_${idx}`);
            if(!isCheckOK || !hasPhoto) {
                row.classList.add('error');
                errorCount++;
                if(!firstError) firstError = row;
            } else {
                row.classList.remove('error');
            }
        });

        if(errorCount > 0) {
            alert(`âŒ å°šæœ‰ ${errorCount} å€‹é …ç›®æœªå®Œæˆï¼

è¦å®šï¼š
1. æ‰€æœ‰ç´°é …éœ€å‹¾é¸
2. æ¯å€‹é …ç›®ã€Œå¿…é ˆã€æ‹æ”ç…§ç‰‡`);
            firstError.scrollIntoView({behavior:'smooth', block:'center'});
            return;
        }

        // 2. å»ºç«‹å ±å‘Š (æ–°é ­å°¾ + èˆŠå¤§åœ–)
        let reportContent = "";
        
        currentItems.forEach((item, idx) => {
            const subItems = templates[item.template] || [];
            let subHtml = "";
            let isFail = false;
            
            subItems.forEach((sub, sIdx) => {
                const isPass = document.getElementById(`p${idx}_s${sIdx}_pass`).checked;
                const status = isPass ? '<span class="txt-pass">âœ” åˆæ ¼</span>' : '<span class="txt-fail">âœ˜ ç•°å¸¸</span>';
                if(!isPass) isFail = true;
                subHtml += `<div class="report-sub-item">â€¢ ${sub} : ${status}</div>`;
            });

            const noteVal = document.getElementById(`note_${idx}`).value;
            const noteHtml = noteVal ? `<div class="report-note">å‚™è¨»ï¼š${noteVal}</div>` : "";
            const imgEl = document.getElementById(`preview_${idx}`);
            const imgHtml = `<img src="${imgEl.src}" class="report-img-large">`;

            reportContent += `
            <div class="report-item" style="${isFail ? 'border-color:red; background:#fff5f5;' : ''}">
                <div class="report-item-head">
                    <span>${idx+1}. ${item.name}</span>
                    ${isFail ? '<span class="txt-fail">âœ˜ éœ€è¦æ”¹å–„</span>' : '<span class="txt-pass">âœ” åˆæ ¼</span>'}
                </div>
                <div class="report-sub-items">${subHtml}</div>
                ${noteHtml}
                ${imgHtml}
            </div>`;
        });

        const doc = document.implementation.createHTMLDocument(document.title);
        doc.head.innerHTML = document.head.innerHTML; 
        doc.body.className = "report-body";
        doc.body.innerHTML = `
            <div class="report-header">
                <div class="report-title">${document.title}</div>
            </div>
            
            <div class="report-info-bar">
                äººå“¡ï¼š${inspectorNames} &nbsp;|&nbsp; 
                ç³»çµ±ï¼š${currentSystem} - ${currentArea} &nbsp;|&nbsp; 
                æ—¥æœŸï¼š${document.getElementById('checkDate').value}
            </div>

            <div class="report-content">
                ${reportContent}
            </div>

            <div class="report-footer">
                <div class="sig-box">
                    <div class="sig-img-final"><img src="${canvas.toDataURL()}" style="height:60px;"></div>
                    <div class="sig-line">æª¢æŸ¥äººå“¡ç°½ç« </div>
                </div>
                <div class="sig-box">
                    <div class="sig-placeholder">(è«‹ç°½æ ¸)</div>
                    <div class="sig-line">éƒ¨é–€ä¸»ç®¡è¤‡æ ¸</div>
                </div>
            </div>
        `;

        const blob = new Blob(["<!DOCTYPE html>"+doc.documentElement.outerHTML], {type: "text/html"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æª¢æŸ¥å ±å‘Š_${currentSystem}_${currentArea}.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function sendEmail() {
        const subject = `æª¢æŸ¥å ±å‘Š: ${currentSystem}-${currentArea}`;
        const body = `è² è²¬äººæ‚¨å¥½ï¼Œé™„ä»¶ç‚º ${document.getElementById('checkDate').value} ä¹‹æª¢æŸ¥å ±å‘Šã€‚`;
        location.href = `mailto:oceanchen@makalot.com.tw?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // iOS Safari Check
    window.addEventListener('load', () => {
       if (("standalone" in window.navigator) && window.navigator.standalone) { document.body.style.paddingTop = "40px"; }
    });
</script>
</body>
</html>
