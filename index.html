<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { padding: 10px; padding-bottom: 120px; background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* === é–±è®€æ¨¡å¼ (ä¸‹è¼‰å¾Œ) === */
        body.readonly-mode { background-color: white; padding: 20px; padding-bottom: 40px; }
        
        /* éš±è—æ“ä½œä»‹é¢ */
        body.readonly-mode .fab-container, 
        body.readonly-mode .backup-controls, 
        body.readonly-mode .btn-upload,
        body.readonly-mode #inspectorBtn,
        body.readonly-mode .btn-check-group, 
        body.readonly-mode .form-text { display: none !important; }
        
        /* éš±è—ç°½åæ¿çš„ç·¨è¼¯å€ (é—œéµä¿®æ”¹) */
        body.readonly-mode .input-mode-only { display: none !important; }
        
        /* é¡¯ç¤ºç°½åçµæœ (é—œéµä¿®æ”¹) */
        body.readonly-mode .report-mode-only { display: block !important; }
        
        /* é è¨­éš±è—å ±å‘Šå…ƒç´  */
        .report-mode-only { display: none; }

        /* éœæ…‹åŒ–æ¨£å¼ */
        .static-text { font-weight: bold; color: #333; padding: 5px 0; }
        .static-result-pass { color: #198754; font-weight: bold; }
        .static-result-fail { color: #dc3545; font-weight: bold; }
        .static-label { color: #0d6efd; font-weight: bold; margin-right: 5px; }

        .panel-row { background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); border-left: 5px solid #ccc; }
        .panel-row.completed { border-left-color: #198754; } 
        .panel-row.error { border-left-color: #dc3545; border: 2px solid #dc3545; background-color: #fff8f8; }

        .sub-item-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        .sub-item-row:last-child { border-bottom: none; }
        .sub-item-label { font-size: 0.95rem; color: #333; line-height: 1.4; }
        
        .badge-type { font-size: 0.75em; background-color: #6c757d; color: white; padding: 3px 8px; border-radius: 4px; margin-left: 8px; white-space: nowrap; }
        .preview-img { max-width: 100%; height: 200px; object-fit: contain; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; display: none; background-color: #f8f9fa;}
        
        /* æµ®å‹•æŒ‰éˆ•å€ */
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; }
        .fab-btn { box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-radius: 50px; padding: 10px 20px; font-weight: bold; font-size: 0.95em; display: flex; align-items: center; justify-content: center; gap: 8px; width: 160px; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.95); }
        
        .backup-controls { margin-bottom: 15px; background: #e9ecef; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .version-tag { font-size: 0.75rem; color: #6c757d; display: block; text-align: center; margin-top: -5px; margin-bottom: 5px; }
        .locked-select { font-weight: bold; font-size: 1.1em; color: #0d6efd; padding: 5px 0; }
        
        .report-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .report-title { font-size: 1.5rem; font-weight: bold; margin: 0; color: #333; }
        .report-meta { color: #666; font-size: 0.8rem; margin-top: 5px; }

        /* ç°½åæ¿æ¨£å¼ (ç·¨è¼¯æ¨¡å¼) */
        .signature-section { margin-top: 20px; }
        .signature-container { position: relative; width: 100%; height: 180px; border: 2px dashed #cbd5e1; border-radius: 10px; background: #fff; margin-bottom: 10px; touch-action: none; }
        .signature-container.error { border: 2px solid #dc3545; background-color: #fff8f8; }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }
        .sig-controls { text-align: right; }
        .btn-clear-sig { background: #fff; border: 1px solid #cbd5e1; padding: 5px 15px; border-radius: 20px; color: #64748b; font-size: 0.85rem; cursor: pointer; }
        
        /* ç°½åæ¿æ¨£å¼ (å ±å‘Šæ¨¡å¼) */
        .signature-final-block { text-align: right; margin-top: 10px; }
        .signature-img-final { max-height: 80px; border-bottom: 2px solid #333; display: inline-block; padding-bottom: 5px; }
        .signature-label { font-weight: bold; font-size: 1.1em; margin-right: 10px; vertical-align: bottom; }
    </style>
</head>
<body>

<div class="fab-container">
    <button type="button" class="btn btn-success fab-btn" onclick="sendEmail()">
        ğŸ“§ å¯„çµ¦è² è²¬äºº
    </button>
    <button type="button" class="btn btn-primary fab-btn" onclick="downloadReport()">
        ğŸ“¥ ä¸‹è¼‰å ±å‘Š
    </button>
    <button type="button" class="btn btn-danger fab-btn" onclick="clearDraft()">
        ğŸ—‘ï¸ æ¸…é™¤é‡å¡«
    </button>
</div>

<div class="container mb-5" style="max-width: 800px;">
    <div class="sticky-top bg-white p-3 shadow-sm mb-3 rounded app-header" style="z-index: 1000; margin: -10px -10px 10px -10px;">
        <h5 class="text-center fw-bold m-0" id="pageTitle">èšé™½å¯¦æ¥­ - è‡ªå‹•æª¢æŸ¥è¨ˆç•«ç¸½è¡¨</h5>
        <span class="version-tag">Ver: v16</span>
        <div class="progress mt-2" style="height: 6px;">
            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <small class="text-muted" id="progressText" style="font-size: 0.8em;">è«‹å…ˆé¸æ“‡ç³»çµ±...</small>
            <small class="text-success fw-bold" id="autoSaveStatus" style="display:none; font-size: 0.8em;">âœ… å·²å­˜</small>
        </div>
    </div>
    
    <div class="backup-controls">
        <span class="fw-bold d-none d-sm-inline">ğŸ“‚ å‚™ä»½</span>
        <button type="button" class="btn btn-sm btn-outline-dark flex-fill" onclick="exportBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½</button>
        <label class="btn btn-sm btn-outline-dark flex-fill m-0">
            â¬†ï¸ è®€å–å‚™ä»½
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(this)">
        </label>
    </div>

    <form id="checkForm">
        <div class="card p-3 mb-3 border-0 shadow-sm">
            <h5 class="card-title fw-bold mb-3">ğŸ“‹ åŸºæœ¬è³‡æ–™</h5>
            
            <div class="mb-2" id="div-system">
                <label class="form-label text-primary fw-bold mb-1">1. ç³»çµ± System</label>
                <select class="form-select form-select-lg" id="systemSelect" onchange="changeSystem()">
                    <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
                </select>
            </div>

            <div class="mb-2" id="div-area">
                <label class="form-label text-primary fw-bold mb-1">2. å€åŸŸ Area</label>
                <select class="form-select form-select-lg" id="areaSelect" onchange="changeArea()" disabled>
                    <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
                </select>
            </div>

            <div class="row g-2 mb-2">
                <div class="col-6" id="div-date">
                    <label class="form-label mb-1">æ—¥æœŸ Date</label>
                    <input type="text" class="form-control bg-light" id="checkDate" readonly>
                </div>
                <div class="col-6" id="div-inspector">
                    <label class="form-label mb-1">äººå“¡ Inspector</label>
                    <button type="button" class="btn btn-outline-secondary w-100 text-start text-truncate" id="inspectorBtn" onclick="toggleInspectorModal()">è«‹é¸æ“‡...</button>
                    <div id="inspectorTextLocked" style="display:none;" class="locked-select text-dark"></div>
                </div>
            </div>
            
            <div id="inspectorModal" class="p-3 border rounded bg-light mt-2" style="display: none;">
                <div class="d-flex flex-wrap gap-2">
                    <div class="form-check bg-white px-3 py-1 rounded border"><input class="form-check-input inspector-check" type="checkbox" value="Albert" onchange="autoSave(); updateInspectorBtn()"><label class="form-check-label">Albert</label></div><div class="form-check bg-white px-3 py-1 rounded border"><input class="form-check-input inspector-check" type="checkbox" value="Alden" onchange="autoSave(); updateInspectorBtn()"><label class="form-check-label">Alden</label></div><div class="form-check bg-white px-3 py-1 rounded border"><input class="form-check-input inspector-check" type="checkbox" value="Ocean" onchange="autoSave(); updateInspectorBtn()"><label class="form-check-label">Ocean</label></div><div class="form-check bg-white px-3 py-1 rounded border"><input class="form-check-input inspector-check" type="checkbox" value="Stenfer" onchange="autoSave(); updateInspectorBtn()"><label class="form-check-label">Stenfer</label></div>
                    <div class="form-check bg-white px-3 py-1 rounded border">
                        <input class="form-check-input inspector-check" type="checkbox" value="Other" id="inspOther" onchange="toggleOtherInput(); autoSave(); updateInspectorBtn()">
                        <label class="form-check-label" for="inspOther">Other</label>
                    </div>
                </div>
                <input type="text" class="form-control mt-2" id="otherNameInput" placeholder="è«‹è¼¸å…¥å§“å..." style="display: none;" oninput="autoSave(); updateInspectorBtn()">
            </div>
        </div>

        <div id="panelList"></div>

        <div class="card p-3 mb-3 border-0 shadow-sm signature-section" id="sig-section" style="display:none;">
            <h5 class="card-title fw-bold mb-2">âœï¸ æª¢æŸ¥äººå“¡ç°½ç« </h5>
            
            <p class="text-muted small mb-1 input-mode-only">è«‹åœ¨ä¸‹æ–¹æ¡†ç·šå…§ç°½å (å¿…å¡«)ï¼š</p>
            <div class="signature-container input-mode-only" id="sig-container">
                <canvas id="sig-canvas"></canvas>
            </div>
            <div class="sig-controls input-mode-only">
                <button type="button" class="btn-clear-sig" onclick="clearSignature()">â†º æ¸…é™¤é‡ç°½</button>
            </div>

            <div class="signature-final-block report-mode-only">
                <span class="signature-label">ç°½ç« ï¼š</span>
                <img src="" class="signature-img-final" id="sig-img-final">
            </div>
        </div>

    </form>
</div>

<script type="application/json" id="data-payload"></script>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.onupdatefound = () => {
                const installingWorker = reg.installing;
                installingWorker.onstatechange = () => {
                    if (installingWorker.state === 'installed' && navigator.serviceWorker.controller && confirm("æœ‰æ–°ç‰ˆæœ¬ï¼è«‹æŒ‰ç¢ºå®šæ›´æ–°ã€‚")) window.location.reload();
                };
            };
        }).catch(console.error);
    }

    const allData = {"(æ¯æœˆ)æ¶ˆé˜²è¨­å‚™èˆ‡ä¸€èˆ¬ç’°å¢ƒå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "2Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "2Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "2Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "2Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "2Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "2Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "2Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "2Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "3F": [{"name": "3Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "3Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "3Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "3Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "3Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "3Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "3Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "3Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "3Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "4F": [{"name": "4Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "4Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "4Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "4Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "4Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "4Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "4Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "4Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "4Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "5F": [{"name": "5Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "5Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "5Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "5Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "5Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "5Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "5Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "5Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "5Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "6F": [{"name": "6Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "6Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "6Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "6Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "6Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "6Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "6Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "6Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "6Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "7F": [{"name": "7Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "7Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "7Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "7Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "7Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "7Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "7Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "7Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "7Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}], "8F": [{"name": "8Fæ»…ç«å™¨001", "template": "æ»…ç«å™¨"}, {"name": "8Fæ¶ˆé˜²æ “ç®±001", "template": "æ¶ˆé˜²æ “ç®±"}, {"name": "8Fç«ç½æ¢æ¸¬å™¨001", "template": "ç«ç½æ¢æ¸¬å™¨"}, {"name": "8Fç«ç½è­¦éˆ´/å»£æ’­001", "template": "ç«ç½è­¦éˆ´/å»£æ’­"}, {"name": "8Få‡ºå£æ¨™ç¤ºç‡ˆ001", "template": "å‡ºå£æ¨™ç¤ºç‡ˆ"}, {"name": "8Fç·Šæ€¥ç…§æ˜ç‡ˆ001", "template": "ç·Šæ€¥ç…§æ˜ç‡ˆ"}, {"name": "8Fé˜²ç«é–€åŒ—é¢", "template": "é˜²ç«é–€"}, {"name": "8Fé˜²ç«é–€å—é¢", "template": "é˜²ç«é–€"}, {"name": "8Fç’°å¢ƒ", "template": "ä½œæ¥­ç’°å¢ƒ"}]}, "(æ¯æœˆ)ç™¼é›»æ©Ÿè¨­å‚™å®šæœŸæª¢æŸ¥": {"ç¸½éƒ¨æ©Ÿæˆ¿": [{"name": "4Fç™¼é›»æ©Ÿ", "template": "ç™¼é›»æ©Ÿ"}]}, "(æ¯å­£)ç©ºèª¿è¨­å‚™å®šæœŸæª¢æŸ¥": {"ç©ºèª¿è¨­å‚™": [{"name": "2Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "3Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "4Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "5Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "6Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "7Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}, {"name": "8Fç©ºèª¿", "template": "ä¸­å¤®ç©ºèª¿"}]}, "(æ¯å­£)é£²æ°´æ©Ÿå®šæœŸæª¢æŸ¥": {"2F": [{"name": "2Fé£²æ°´æ©Ÿ", "template": "2Fé£²æ°´æ©Ÿ"}], "3F": [{"name": "3Fé£²æ°´æ©Ÿ", "template": "3Fé£²æ°´æ©Ÿ"}], "4F": [{"name": "4Fé£²æ°´æ©Ÿ", "template": "4Fé£²æ°´æ©Ÿ"}], "5F": [{"name": "5Fé£²æ°´æ©Ÿ", "template": "5Fé£²æ°´æ©Ÿ"}], "6F": [{"name": "6Fé£²æ°´æ©Ÿ", "template": "6Fé£²æ°´æ©Ÿ"}], "7F": [{"name": "7Fé£²æ°´æ©Ÿ", "template": "7Fé£²æ°´æ©Ÿ"}], "8F": [{"name": "8Fé£²æ°´æ©Ÿ", "template": "8Fé£²æ°´æ©Ÿ"}]}, "(æ¯å¹´)ä½å£“é›»æ°£è¨­å‚™å®šæœŸæ’¿æŸ¥": {"2F": [{"name": "2-HR", "template": "é›»ç®±"}, {"name": "2-L", "template": "é›»ç®±"}, {"name": "2-R", "template": "é›»ç®±"}, {"name": "2-MP", "template": "é›»ç®±"}, {"name": "MP1 (2F)", "template": "é›»ç®±"}, {"name": "MA1 (2F)", "template": "é›»ç®±"}, {"name": "L2 (2F)", "template": "é›»ç®±"}, {"name": "å‰µç ”è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "2Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "2-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "2MLR", "template": "é›»ç®±"}, {"name": "MA-2é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "MA-3é–‹é—œç›¤", "template": "é›»ç®±"}, {"name": "2MLR-Aç›¤", "template": "é›»ç®±"}, {"name": "å·¥å‹™è™•ç©ºèª¿ç›¤", "template": "é›»ç®±"}], "3F": [{"name": "3F A-1", "template": "é›»ç®±"}, {"name": "3F A-2", "template": "é›»ç®±"}, {"name": "3F B", "template": "é›»ç®±"}], "4F": [{"name": "4-Ræ’åº§", "template": "é›»ç®±"}, {"name": "4-HRæ’åº§", "template": "é›»ç®±"}, {"name": "4-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "4-MLRç›¤", "template": "é›»ç®±"}, {"name": "4Fç©ºèª¿ç›¤", "template": "é›»ç®±"}], "5F": [{"name": "5-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "5MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "5Fç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "5MLRç›¤", "template": "é›»ç®±"}], "6F": [{"name": "6-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "6-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "6æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "6-MLRç›¤", "template": "é›»ç®±"}], "7F": [{"name": "7Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "7MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "7æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "7MLRç›¤", "template": "é›»ç®±"}], "8F": [{"name": "8-Ræ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-HRæ’åº§ç›¤", "template": "é›»ç®±"}, {"name": "8-MLé›»ç‡ˆç›¤", "template": "é›»ç®±"}, {"name": "8æ¨“ç©ºèª¿ç›¤", "template": "é›»ç®±"}, {"name": "8-MLRç›¤", "template": "é›»ç®±"}]}};
    const templates = {"é›»ç®±": ["1. å¤–æ®¼èˆ‡é–€è“‹é–æ‰£ (å¤–è§€å®Œæ•´)", "2. å‘¨åœç’°å¢ƒ (ç„¡é›œç‰©/ç©æ°´)", "3. ç·šè·¯æ¥é»æº«åº¦ (ç„¡ç•°å¸¸ç™¼ç†±)", "4. ä¿è­·è£ç½®åŠŸèƒ½ (æ¨™ç¤ºæ¸…æ™°)"], "æ»…ç«å™¨": ["1. å£“åŠ›è¡¨(ç¶ è‰²ç¯„åœ)", "2. å®‰å…¨æ’éŠ·(æ­£å¸¸ä¸”æœªæ‹†å°)", "3. çš®ç®¡å™´å˜´(ç„¡è®Šå½¢ç•°å¸¸)", "4. ç“¶èº«å¤–è§€(ç„¡é½è•è®Šå½¢)", "5. æ¨™ç¤ºæœŸé™(æ¸…æ™°ã€æª¢æŸ¥å¡ã€è—¥åŠ‘)", "6. æ“ºæ”¾ä½ç½®(æ˜“å–å¾—ã€å­—æ¨£æ¸…æ™°)"], "æ¶ˆé˜²æ “ç®±": ["1. ç®±é«”å‘¨åœ(é›œç‰©å †ç©)", "2. æŒ‡ç¤ºç‡ˆ(æ˜¯å¦ç´…ç‡ˆæ†äº®)", "3. ç®±é–€é–‹é—œ(æ˜¯å¦èƒ½æ­£å¸¸é–‹å•Ÿ)", "4. ç„å­(å™´å˜´æ˜¯å¦æ­£å¸¸)", "5. æ°´å¸¶(æ‘ºç–Šæ›å¥½)", "6. é–‹é—œé–¥(æ­£å¸¸å®Œå¥½)"], "ç«ç½æ¢æ¸¬å™¨": ["1. æ˜¯å¦è¢«è£æ½¢ã€å†·æ°£å‡ºé¢¨å£é®è”½", "2. æ˜¯å¦è¢«é«˜ç–Šçš„è²¨ç‰©ï¼ˆæ¨£å“ï¼‰é˜»æ“‹æ„Ÿæ‡‰", "3. å¤–è§€æ˜¯å¦é¬†è„«ã€æ‡¸åŠ"], "ç«ç½è­¦éˆ´/å»£æ’­": ["1. å¤–è§€æ˜¯å¦å®Œå¥½", "2. æœ‰ç„¡è¢«å°æ­»æˆ–ç ´å£"], "å‡ºå£æ¨™ç¤ºç‡ˆ": ["1. æ˜¯å¦24å°æ™‚æ†äº®", "2. ç‡ˆç½©æ˜¯å¦ç ´æã€æ¨¡ç³Š", "3. æ˜¯å¦è¢«è£æ½¢é®è”½"], "ç·Šæ€¥ç…§æ˜ç‡ˆ": ["1. æ’é ­æ˜¯å¦æ’åœ¨æ’åº§ä¸Š", "2. æ¸¬è©¦éˆ•æŒ‰ä¸‹æ˜¯å¦æœƒäº®", "3. å¤–è§€æ˜¯å¦ç„¦é»‘æˆ–é›»æ± æ¼æ¶²"], "é˜²ç«é–€": ["1. æ˜¯å¦å¸¸æ™‚é—œé–‰", "2. æ˜¯å¦å †æ”¾é›œç‰©é˜»ç¤™é–‹å•Ÿ", "3. é–€å¼“å™¨æ˜¯å¦èƒ½è‡ªå‹•å°‡é–€å¸¶ä¸Š"], "ç™¼é›»æ©Ÿ": ["1. ç‡ƒæ–™å­˜é‡èˆ‡ç®¡ç·š (ç„¡æ´©æ¼)", "2. æ©Ÿæ²¹/å†·å»æ°´ (æ¶²ä½æ­£å¸¸)", "3. æ’ç…™èˆ‡é€šé¢¨ (é †æš¢ç„¡æ)", "4. å™ªéŸ³èˆ‡éœ‡å‹• (ç„¡ç•°å¸¸)", "5. é›»ç“¶é›»å£“ (æ¥é ­ç„¡è…è•)", "6. ATSè‡ªå‹•åˆ‡æ› (æ¸¬è©¦æ­£å¸¸)", "7. è¼¸å‡ºé›»å£“é »ç‡ (æ¨™æº–ç¯„åœ)", "8. æ¥åœ°ç·šé€£æ¥ (ç„¡é¬†è„«)"], "2Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "3Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "4Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "5Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "6Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "7Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "8Fé£²æ°´æ©Ÿ": ["1. æ°´è³ªæª¢æ¸¬å ±å‘Šæ›¸(3æœˆå…§)", "2. ç¶­è­·ç´€éŒ„å¡(ç°½åã€æ›´æ›é …ç›®)", "3. å–®ä½è² è²¬äººæ¨™ç¤º", "4. æ˜¯å¦æœ‰å™´æ¿ºç©æ°´æƒ…å½¢", "5. å‘¨é‚Šç’°å¢ƒ(æ°´æ¼¬ã€æ’é ­ç„¦é»‘ã€æ¼æ°´æ„Ÿé›»ã€æ¥åœ°)", "6. é˜²ç‡™ç†±æ°´é–", "7. æ˜¯å¦ç©©å›ºä¸æ˜“å‚¾å€’"], "ä¸­å¤®ç©ºèª¿": ["1. ä¸»æ©Ÿé‹è½‰ç‹€æ…‹ (ç„¡ç•°éŸ³)", "2. æ•£ç†±æ’/éæ¿¾ç¶² (æ¸…æ½”)", "3. è¨­å‚™å‘¨åœç’°å¢ƒ (é€šé¢¨)", "4. æ’æ°´ç›¤/å†·å‡æ°´ç®¡ (ç„¡å µå¡)", "5. å†°æ°´ç®¡ç·šä¿æº« (ç„¡æ»´æ°´)", "6. é›»æ°£æ¥é» (ç„¡éç†±)", "7. å®‰å…¨é˜²è­·è£ç½® (åŠŸèƒ½æ­£å¸¸)"], "ä½œæ¥­ç’°å¢ƒ": ["1. èµ°é“èˆ‡ç·Šæ€¥å‡ºå£ (ç„¡å †ç©)", "2. ç…§æ˜æ­£å¸¸èˆ‡ç‡ˆå…·ç„¡æå£", "3. å»¶é•·ç·šèˆ‡é›»ç·š (ç„¡å£“é‡ç‰©)", "4. é£²æ°´æ©Ÿ/åŠ ç†±è¨­å‚™ (ç„¡æ¼æ°´/æ¼é›»)", "5. å»¢æ£„ç‰©è™•ç† (åˆ†é¡æ­£ç¢º)"]};
    let currentSystem = "", currentArea = "", currentItems = [];
    
    const DB_NAME = "ChecklistDB_V8"; const DB_VERSION = 1; let db;
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = function(e) { db = e.target.result; if(!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = function(e) { db = e.target.result; initPage(); };

    // === ç°½åæ¿é‚è¼¯ ===
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        if(canvas.width !== rect.width) {
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        }
    }
    window.addEventListener('resize', resizeCanvas);
    
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function startDraw(e) { isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); e.preventDefault(); }
    function draw(e) { if (!isDrawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); }
    function stopDraw() { if(isDrawing) { isDrawing = false; autoSave(); } } 

    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stopDraw);
    
    function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); autoSave(); }
    function isCanvasBlank() { const blank = document.createElement('canvas'); blank.width = canvas.width; blank.height = canvas.height; return canvas.toDataURL() === blank.toDataURL(); }

    function initPage() {
        setInitTime();
        const sysSelect = document.getElementById('systemSelect');
        Object.keys(allData).forEach(sys => { const opt = document.createElement("option"); opt.value = sys; opt.text = sys; sysSelect.appendChild(opt); });
        
        if (!document.body.classList.contains('readonly-mode')) {
            const savedSys = localStorage.getItem('last_system');
            const savedArea = localStorage.getItem('last_area');
            if(savedSys && allData[savedSys]) {
                sysSelect.value = savedSys; changeSystem();
                if(savedArea && allData[savedSys][savedArea]) { document.getElementById('areaSelect').value = savedArea; changeArea(); }
            }
        }
    }

    function setInitTime() {
        const now = new Date();
        if(!document.getElementById('checkDate').value) {
            const dateStr = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0') + "-" + String(now.getDate()).padStart(2,'0') + " " + String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            document.getElementById('checkDate').value = dateStr;
        }
    }

    function toggleOtherInput() {
        document.getElementById('otherNameInput').style.display = document.getElementById('inspOther').checked ? 'block' : 'none';
        updateInspectorBtn();
    }
    function updateInspectorBtn() {
        const checked = document.querySelectorAll('.inspector-check:checked');
        const names = [];
        checked.forEach(c => names.push(c.value === 'Other' ? (document.getElementById('otherNameInput').value || 'Other') : c.value));
        document.getElementById('inspectorBtn').innerText = names.length > 0 ? names.join(", ") : "è«‹é¸æ“‡äººå“¡...";
    }
    function toggleInspectorModal() {
        const m = document.getElementById('inspectorModal'); m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }

    function changeSystem() {
        currentSystem = document.getElementById('systemSelect').value;
        const areaSelect = document.getElementById('areaSelect');
        areaSelect.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡å€åŸŸ --</option>'; areaSelect.disabled = false;
        Object.keys(allData[currentSystem]).forEach(area => { const opt = document.createElement("option"); opt.value = area; opt.text = area; areaSelect.appendChild(opt); });
        document.getElementById('panelList').innerHTML = ""; currentItems = []; 
        localStorage.setItem('last_system', currentSystem);
        document.getElementById('sig-section').style.display = 'none';
    }
    function changeArea() {
        currentArea = document.getElementById('areaSelect').value;
        currentItems = allData[currentSystem][currentArea];
        document.getElementById('pageTitle').innerText = `${currentSystem} - ${currentArea}`;
        localStorage.setItem('last_area', currentArea);
        renderPanels(); 
        document.getElementById('sig-section').style.display = 'block';
        resizeCanvas();
        loadDraftFromDB();
    }

    function renderPanels() {
        const container = document.getElementById('panelList'); container.innerHTML = "";
        if (!currentItems) return;
        currentItems.forEach((itemObj, pIndex) => {
            const subItems = templates[itemObj.template] || [];
            let subItemsHtml = '';
            subItems.forEach((checkItem, sIndex) => {
                subItemsHtml += `
                <div class="sub-item-row" id="sub_row_${pIndex}_${sIndex}">
                    <div class="sub-item-label">${checkItem}</div>
                    <div class="sub-item-btn-group">
                        <div class="btn-group w-100 btn-check-group" role="group">
                            <input type="radio" class="btn-check" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_pass" value="åˆæ ¼" onchange="autoSave()">
                            <label class="btn btn-outline-success flex-fill" for="p${pIndex}_s${sIndex}_pass">åˆæ ¼</label>
                            <input type="radio" class="btn-check" name="p${pIndex}_s${sIndex}" id="p${pIndex}_s${sIndex}_fail" value="ä¸åˆæ ¼" onchange="autoSave()">
                            <label class="btn btn-outline-danger flex-fill" for="p${pIndex}_s${sIndex}_fail">ç•°å¸¸</label>
                        </div>
                        <div class="static-result" style="display:none;"></div>
                    </div>
                </div>`;
            });
            const html = `
            <div class="panel-row" id="row_${pIndex}">
                <div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center flex-wrap">
                        <h5 class="fw-bold text-primary m-0 me-2">${pIndex + 1}. ${itemObj.name}</h5>
                        <span class="badge-type">${itemObj.template}</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary text-nowrap ms-2 btn-upload" onclick="setAllPass(${pIndex}, ${subItems.length})">âš¡ ä¸€éµ</button>
                </div>
                <div class="mb-3">${subItemsHtml}</div>
                <input type="text" class="form-control mb-2" id="note_${pIndex}" placeholder="å‚™è¨»..." oninput="autoSave()">
                <label class="btn btn-secondary btn-sm w-100 mb-2 btn-upload">
                    ğŸ“· æ‹æ”/ä¸Šå‚³
                    <input type="file" id="img_${pIndex}" accept="image/*" capture="environment" style="display: none;" onchange="compressAndPreview(this, ${pIndex})">
                </label>
                <div class="text-center"><img id="preview_${pIndex}" class="preview-img"></div>
            </div>`;
            container.innerHTML += html;
        });
    }

    function setAllPass(pIndex, count) {
        for(let s=0; s<count; s++) { const el = document.getElementById(`p${pIndex}_s${s}_pass`); if(el) el.checked = true; }
        autoSave();
        document.getElementById(`row_${pIndex}`).classList.remove('error');
    }

    function compressAndPreview(input, index) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1024;
                    let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    const imgEl = document.getElementById(`preview_${index}`);
                    imgEl.src = dataUrl; imgEl.style.display = 'inline-block';
                    document.getElementById(`row_${index}`).classList.add("completed");
                    document.getElementById(`row_${index}`).classList.remove('error');
                    autoSave();
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // DB logic
    function getStorageKey() { if(!currentSystem || !currentArea) return null; return `${document.title}_${currentSystem}_${currentArea}`; }
    let saveTimeout; function autoSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { manualSave(true); }, 500); }
    
    function manualSave(silent = false) {
        if (!db) return; const key = getStorageKey(); if (!key) return;
        const data = collectData(); data.id = key;
        db.transaction(["drafts"], "readwrite").objectStore("drafts").put(data);
        if(!silent) { document.getElementById('autoSaveStatus').style.display = 'block'; setTimeout(() => document.getElementById('autoSaveStatus').style.display = 'none', 2000); }
    }

    function collectData() {
        const radios = []; document.querySelectorAll('input[type="radio"]:checked').forEach(r => radios.push(r.id));
        const notes = {}; document.querySelectorAll('input[type="text"][id^="note_"]').forEach(n => { if(n.value) notes[n.id] = n.value; });
        const inspectors = []; document.querySelectorAll('.inspector-check:checked').forEach(i => inspectors.push(i.value));
        const images = {}; document.querySelectorAll('.preview-img').forEach(img => { if (img.src && img.src.startsWith('data:image')) images[img.id] = img.src; });
        const inspectorNames = [];
        document.querySelectorAll('.inspector-check:checked').forEach(c => {
            if (c.value === 'Other') { const val = document.getElementById('otherNameInput').value; if(val) inspectorNames.push(val); } 
            else { inspectorNames.push(c.value); }
        });
        const sigData = isCanvasBlank() ? null : canvas.toDataURL();
        return {
            system: currentSystem, area: currentArea, date: document.getElementById('checkDate').value,
            inspectorText: inspectorNames.join(", "),
            radios: radios, notes: notes, inspectors: inspectors,
            otherName: document.getElementById('otherNameInput').value, images: images, 
            signature: sigData, timestamp: new Date().getTime()
        };
    }

    function loadDraftFromDB() {
        if (!db) return; const key = getStorageKey(); if (!key) return;
        db.transaction(["drafts"]).objectStore("drafts").get(key).onsuccess = function(e) {
            const data = e.target.result;
            if (data) applyData(data);
        };
    }

    function applyData(data) {
        if(data.radios) data.radios.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
        if(data.notes) Object.keys(data.notes).forEach(id => { const el = document.getElementById(id); if(el) el.value = data.notes[id]; });
        document.querySelectorAll('.inspector-check').forEach(c => c.checked = false);
        if(data.inspectors) data.inspectors.forEach(val => { 
            const el = document.querySelector(`.inspector-check[value="${val}"]`); if(el) el.checked = true; 
            if(val === 'Other') { document.getElementById('inspOther').checked = true; toggleOtherInput(); } 
        });
        if(data.otherName) document.getElementById('otherNameInput').value = data.otherName;
        updateInspectorBtn();
        if(data.images) Object.keys(data.images).forEach(id => { 
            const img = document.getElementById(id); 
            if(img) { img.src = data.images[id]; img.style.display = 'inline-block'; const row = document.getElementById(id.replace('preview_', 'row_')); if(row) row.classList.add('completed'); } 
        });
        if(data.signature) {
            const img = new Image();
            img.onload = function() { ctx.drawImage(img, 0, 0); };
            img.src = data.signature;
        }
    }

    function clearDraft() {
        if(!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ­¤å€åŸŸçš„æ‰€æœ‰å…§å®¹å—ï¼Ÿ")) return;
        if (!db) return; const key = getStorageKey();
        db.transaction(["drafts"], "readwrite").objectStore("drafts").delete(key);
        document.getElementById('checkForm').reset(); setInitTime(); toggleOtherInput();
        document.querySelectorAll('.preview-img').forEach(img => { img.src = ""; img.style.display = "none"; });
        document.querySelectorAll('.panel-row').forEach(row => { row.classList.remove('completed'); row.classList.remove('error'); });
        clearSignature(); updateInspectorBtn();
        alert("å·²æ¸…é™¤ï¼");
    }

    function sendEmail() {
        const date = document.getElementById('checkDate').value;
        const sys = currentSystem || "æœªé¸æ“‡";
        const area = currentArea || "æœªé¸æ“‡";
        const subject = encodeURIComponent(`[æª¢æŸ¥è¡¨] ${sys}-${area} ${date}`);
        const body = encodeURIComponent("è«‹è©³é–±é™„æª”æª¢æŸ¥å ±å‘Š (è«‹æ‰‹å‹•é™„åŠ ä¸‹è¼‰çš„ HTML æª”æ¡ˆ)ã€‚");
        window.location.href = `mailto:oceanchen@makalot.com.tw?subject=${subject}&body=${body}`;
    }

    function downloadReport() {
        if(!currentSystem || !currentArea) { alert("è«‹å…ˆé¸æ“‡ç³»çµ±èˆ‡å€åŸŸ"); return; }
        
        const inspectorNames = document.getElementById('inspectorBtn').innerText;
        if(inspectorNames === "è«‹é¸æ“‡äººå“¡..." || inspectorNames === "") {
            alert("âŒ éŒ¯èª¤ï¼šè«‹è‡³å°‘é¸æ“‡ä¸€ä½æª¢æŸ¥äººå“¡ï¼"); return;
        }

        if(isCanvasBlank()) {
            alert("âŒ éŒ¯èª¤ï¼šè«‹åœ¨ä¸‹æ–¹ç°½åæ¬„å®Œæˆç°½ç½²ï¼");
            document.getElementById('sig-container').classList.add('error');
            document.getElementById('sig-container').scrollIntoView({behavior: "smooth", block: "center"});
            return;
        } else {
            document.getElementById('sig-container').classList.remove('error');
        }

        let missingCount = 0;
        let firstMissingElem = null;
        currentItems.forEach((itemObj, pIndex) => {
            const subItems = templates[itemObj.template] || [];
            let isCheckComplete = true;
            let isPhotoUploaded = false;

            subItems.forEach((_, sIndex) => {
                const pass = document.getElementById(`p${pIndex}_s${sIndex}_pass`);
                const fail = document.getElementById(`p${pIndex}_s${sIndex}_fail`);
                if (!pass.checked && !fail.checked) isCheckComplete = false;
            });

            const imgEl = document.getElementById(`preview_${pIndex}`);
            if (imgEl && imgEl.src && imgEl.style.display !== 'none') isPhotoUploaded = true;

            const row = document.getElementById(`row_${pIndex}`);
            if (!isCheckComplete || !isPhotoUploaded) {
                row.classList.add('error'); missingCount++;
                if(!firstMissingElem) firstMissingElem = row;
            } else { row.classList.remove('error'); }
        });

        if (missingCount > 0) {
            alert(`âŒ éŒ¯èª¤ï¼šé‚„æœ‰ ${missingCount} å€‹è¨­å‚™æœªå®Œæˆï¼

è«‹ç¢ºèªï¼š
1. æ‰€æœ‰ç´°é …çš†å·²å‹¾é¸
2. æ¯å€‹è¨­å‚™çš†å·²æ‹æ”ç…§ç‰‡ (å¿…è¦)`);
            firstMissingElem.scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }

        const doc = document.documentElement.cloneNode(true);
        const body = doc.querySelector('body');
        body.classList.add('readonly-mode');
        
        const appHeader = doc.querySelector('.app-header');
        if(appHeader) appHeader.remove();

        const reportTitleDiv = document.createElement('div');
        reportTitleDiv.className = 'report-header';
        reportTitleDiv.innerHTML = `
            <div class="report-title">${document.title}</div>
            <div class="report-meta">Ver: ${document.querySelector('.version-tag').innerText.replace('Ver: ', '')} | Exported: ${new Date().toLocaleDateString()}</div>
        `;
        doc.querySelector('.container').prepend(reportTitleDiv);

        const sysVal = document.getElementById('systemSelect').value;
        const areaVal = document.getElementById('areaSelect').value;
        doc.querySelector('#div-system').innerHTML = `<span class="static-label">ç³»çµ±:</span><span class="static-text">${sysVal}</span>`;
        doc.querySelector('#div-area').innerHTML = `<span class="static-label">å€åŸŸ:</span><span class="static-text">${areaVal}</span>`;
        
        const dateVal = document.getElementById('checkDate').value;
        doc.querySelector('#div-date').innerHTML = `<span class="static-label">æ—¥æœŸ:</span><span class="static-text">${dateVal}</span>`;
        doc.querySelector('#div-inspector').innerHTML = `<span class="static-label">äººå“¡:</span><span class="static-text">${inspectorNames}</span>`;
        doc.querySelector('#inspectorModal').remove();

        const sigImgEl = doc.querySelector('#sig-img-final');
        sigImgEl.src = canvas.toDataURL();
        
        currentItems.forEach((itemObj, pIndex) => {
            const subItems = templates[itemObj.template] || [];
            subItems.forEach((_, sIndex) => {
                const pass = document.getElementById(`p${pIndex}_s${sIndex}_pass`).checked;
                const fail = document.getElementById(`p${pIndex}_s${sIndex}_fail`).checked;
                const subRow = doc.querySelector(`#sub_row_${pIndex}_${sIndex}`);
                const btnGroup = subRow.querySelector('.sub-item-btn-group');
                let resultHtml = "";
                if(pass) resultHtml = '<span class="static-result-pass">âœ… åˆæ ¼</span>';
                else if(fail) resultHtml = '<span class="static-result-fail">âŒ ç•°å¸¸</span>';
                btnGroup.innerHTML = resultHtml;
            });
            
            const noteInput = doc.querySelector(`#note_${pIndex}`);
            if(noteInput) {
                const noteVal = document.getElementById(`note_${pIndex}`).value;
                if(noteVal) {
                    const noteDiv = document.createElement('div');
                    noteDiv.innerHTML = `<span class="static-label">å‚™è¨»:</span>${noteVal}`;
                    noteDiv.style.marginTop = "5px";
                    noteInput.replaceWith(noteDiv);
                } else { noteInput.remove(); }
            }
        });
        
        const data = collectData();
        doc.querySelector('#data-payload').textContent = JSON.stringify(data);
        doc.querySelectorAll('.fab-container, .backup-controls, .btn-upload, script').forEach(el => { if(el.id !== 'data-payload') el.remove(); });

        const htmlContent = "<!DOCTYPE html>" + doc.outerHTML;
        const blob = new Blob([htmlContent], {type: "text/html"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        const dateStr = document.getElementById('checkDate').value.replace(/[: ]/g, '_');
        a.download = `${currentSystem}_${currentArea}_${dateStr}.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function exportBackup() {
        if (!db) return; const key = getStorageKey(); if (!key) { alert("è«‹å…ˆé¸æ“‡å€åŸŸ"); return; }
        db.transaction(["drafts"]).objectStore("drafts").get(key).onsuccess = function(e) {
            const data = e.target.result; if(!data) { alert("ç„¡è³‡æ–™å¯å‚™ä»½"); return; }
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
            a.download = `backup_${currentSystem}_${currentArea}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
    }

    function importBackup(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result); data.id = getStorageKey();
                const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
                tx.oncomplete = function() { alert("âœ… å‚™ä»½è®€å–æˆåŠŸï¼"); loadDraftFromDB(); };
            } catch(err) { alert("è®€å–å¤±æ•—"); }
        };
        reader.readAsText(file); input.value = '';
    }
</script>
</body>
</html>
